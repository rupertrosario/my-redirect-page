import { credentialVaultClient } from "@dynatrace-sdk/client-classic-environment-v2";
import { result } from "@dynatrace-sdk/automation-utils";

/**
 * cohesity_backup_failures_p2 (PASS-THROUGH)
 * READ-ONLY (GET-only)
 * - Includes vault section (as requested)
 * - Reads Part 1 via result("cohesity_backup_failures_p1")
 * - NO Helios calls => avoids timeouts
 *
 * Output -> Part 3 uses result("cohesity_backup_failures_p2")
 */
export default async function () {
  const PART1_TASK = "cohesity_backup_failures_p1";
  const p1 = await result(PART1_TASK);
  if (!p1 || !Array.isArray(p1.pgIndex)) {
    throw new Error(`Part 2: missing Part 1 output. Check task name: ${PART1_TASK}`);
  }

  // Vault auth (same pattern)
  const vaultId = "credentials_vault-312312";
  const d2 = await credentialVaultClient.getCredentialsDetails({ id: vaultId });
  const apiKey = (d2?.token || d2?.password || "").trim();
  if (!apiKey) throw new Error("No Helios API key available (empty token/password).");

  return {
    authMode: "vault",
    baseUrl: p1.baseUrl || "https://helios.cohesity.com",
    numRuns: Number(p1.numRuns ?? 10),
    pgIndex: p1.pgIndex,
    pgIndexCount: Number(p1.pgIndexCount ?? p1.pgIndex.length),
  };
}
