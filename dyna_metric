// Dynatrace Workflow JavaScript ‚Äì Metrics Ingest Only
// Requires workflow permission: environment-api:metrics:ingest
import { metricsClient } from '@dynatrace-sdk/client-classic-environment-v2';

export default async function (inputs) {
  console.log("üìà Ingesting Cohesity cluster metrics from previous step output‚Ä¶");

  // --- 1Ô∏è‚É£ Read clusters array from Step 1 output ---
  // The workflow editor passes {{ steps.cohesity_get.output.clusters }} as 'inputs.clusters'
  let clusters = [];
  if (Array.isArray(inputs?.clusters)) {
    clusters = inputs.clusters;
  } else if (typeof inputs?.clusters === "string") {
    try { clusters = JSON.parse(inputs.clusters); } catch { clusters = []; }
  }

  if (!Array.isArray(clusters) || clusters.length === 0) {
    console.log("‚ÑπÔ∏è No clusters provided ‚Üí nothing to ingest.");
    return { ingestedLines: 0, clusterCount: 0 };
  }

  // --- 2Ô∏è‚É£ Build Dynatrace Metrics v2 payload ---
  const lines = [];
  for (const r of clusters) {
    const name = (r.clusterName ?? "").toString().replace(/"/g, '\\"');
    const id   = (r.clusterId ?? "").toString();
    const dims = `clusterName="${name}",clusterId="${id}"`;

    const totalTiB = Number(r.totalTiB ?? 0);
    const usedTiB  = Number(r.usedTiB ?? 0);
    const availTiB = Number(r.availTiB ?? 0);
    const consumed = Number(r.consumedPercent ?? 0);
    const garbageGB= Number(r.garbageGB ?? 0);
    const garbageTB= Number(r.garbageTB ?? 0);

    lines.push(
      `cohesity.capacity.total.tib,${dims} ${totalTiB}`,
      `cohesity.capacity.used.tib,${dims} ${usedTiB}`,
      `cohesity.capacity.avail.tib,${dims} ${availTiB}`,
      `cohesity.capacity.consumed.percent,${dims} ${consumed}`,
      `cohesity.garbage.gb,${dims} ${garbageGB}`,
      `cohesity.garbage.tb,${dims} ${garbageTB}`
    );
  }

  // --- 3Ô∏è‚É£ Ingest to Dynatrace ---
  if (lines.length === 0) {
    console.log("‚ÑπÔ∏è No metrics to ingest (lines array empty).");
    return { ingestedLines: 0, clusterCount: clusters.length };
  }

  console.log(`üì° Ingesting ${lines.length} metric lines to Dynatrace‚Ä¶`);
  await metricsClient.ingest({ body: lines.join('\n') });
  console.log("‚úÖ Metrics successfully ingested.");

  return { ingestedLines: lines.length, clusterCount: clusters.length };
}

{
  "clusters": {{ steps.cohesity_get.output.clusters }}
}

