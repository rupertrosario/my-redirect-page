// Dynatrace Workflow: Run JavaScript (Metrics ingest only)
// Requires workflow permission: environment-api:metrics:ingest
import { metricsClient } from '@dynatrace-sdk/client-classic-environment-v2';

export default async function (inputs) {
  console.log("üìà Ingesting Cohesity cluster metrics from previous step output‚Ä¶");

  // We accept either an array or a JSON string (depending on how you wire the input)
  let clusters = [];
  if (Array.isArray(inputs?.clusters)) {
    clusters = inputs.clusters;
  } else if (typeof inputs?.clusters === 'string') {
    try { clusters = JSON.parse(inputs.clusters); } catch { clusters = []; }
  }

  if (!Array.isArray(clusters) || clusters.length === 0) {
    console.log("‚ÑπÔ∏è No clusters provided to metrics step. Nothing to ingest.");
    return { ingestedLines: 0, clusterCount: 0 };
  }

  // Build Dynatrace Metrics v2 payload
  const lines = [];
  for (const r of clusters) {
    // Expecting the shape produced by your first step
    // {
    //   clusterName, clusterId,
    //   totalTiB, usedTiB, availTiB,
    //   consumedPercent, garbageGB, garbageTB
    // }
    const name = (r.clusterName ?? "").toString().replace(/"/g, '\\"');
    const id   = (r.clusterId ?? "").toString();

    const dims = `clusterName="${name}",clusterId="${id}"`;

    // Guard against undefineds; default to 0
    const totalTiB = Number(r.totalTiB ?? 0);
    const usedTiB  = Number(r.usedTiB ?? 0);
    const availTiB = Number(r.availTiB ?? 0);
    const consumed = Number(r.consumedPercent ?? 0);
    const garbageGB= Number(r.garbageGB ?? 0);
    const garbageTB= Number(r.garbageTB ?? 0);

    lines.push(
      `cohesity.capacity.total.tib,${dims} ${totalTiB}`,
      `cohesity.capacity.used.tib,${dims} ${usedTiB}`,
      `cohesity.capacity.avail.tib,${dims} ${availTiB}`,
      `cohesity.capacity.consumed.percent,${dims} ${consumed}`,
      `cohesity.garbage.gb,${dims} ${garbageGB}`,
      `cohesity.garbage.tb,${dims} ${garbageTB}`
    );
  }

  if (lines.length === 0) {
    console.log("‚ÑπÔ∏è Nothing to ingest (no lines built).");
    return { ingestedLines: 0, clusterCount: clusters.length };
  }

  console.log(`üì° Ingesting ${lines.length} lines to Dynatrace‚Ä¶`);
  await metricsClient.ingest({ body: lines.join('\n') });
  console.log("‚úÖ Metrics successfully ingested.");

  return { ingestedLines: lines.length, clusterCount: clusters.length };
}
