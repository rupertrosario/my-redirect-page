import { credentialVaultClient } from "@dynatrace-sdk/client-classic-environment-v2";

export default async function () {
  var baseUrl = "https://helios.cohesity.com";

  // ------------------------------
  // Auth (same as your other scripts)
  // ------------------------------
  var vaultName = "Cohesity_API_Key";
  var vaultId = "credentials_vault-312312";

  var apiKey = null;
  var authMode = "vault-name";

  async function getKeyByName(name) {
    var all = await credentialVaultClient.getCredentials();
    var found = null;
    for (var i = 0; i < all.credentials.length; i++) {
      if (all.credentials[i].name === name) { found = all.credentials[i]; break; }
    }
    if (!found) return null;

    var detail = await credentialVaultClient.getCredentialsDetails({ id: found.id });
    console.log("✓ Helios key from vault (name): " + found.name);
    return (detail && (detail.token || detail.password)) || null;
  }

  try {
    apiKey = await getKeyByName(vaultName);
    if (!apiKey) throw new Error("not-found");
  } catch (e) {
    try {
      var d2 = await credentialVaultClient.getCredentialsDetails({ id: vaultId });
      apiKey = (d2 && (d2.token || d2.password)) || null;
      authMode = "vault-id";
      console.log("✓ Helios key from vault (id): " + (d2 && d2.name ? d2.name : vaultId));
    } catch (e2) {
      authMode = "manual";
      apiKey = "PASTE_YOUR_API_KEY_HERE";
      console.log("⚠️ Using manual Helios API key (fallback)");
    }
  }

  if (!apiKey) throw new Error("No Helios API key available.");

  var headers = { accept: "application/json", apiKey: apiKey };

  function buildQuery(params) {
    var usp = new URLSearchParams();
    for (var k in params) {
      if (!Object.prototype.hasOwnProperty.call(params, k)) continue;
      var v = params[k];
      if (v === undefined || v === null) continue;
      if (Array.isArray(v)) {
        for (var i = 0; i < v.length; i++) usp.append(k, String(v[i]));
      } else {
        usp.append(k, String(v));
      }
    }
    return usp.toString();
  }

  async function getJsonDebug(url, headers) {
    var resp = await fetch(url, { method: "GET", headers: headers });

    var text = "";
    try { text = await resp.text(); } catch (e) {}

    // Always return status + a snippet even if JSON parse fails
    var json = null;
    try { json = text ? JSON.parse(text) : null; } catch (e2) {}

    return {
      ok: resp.ok,
      status: resp.status,
      statusText: resp.statusText || "",
      textSnippet: text ? text.slice(0, 2500) : "",
      json: json
    };
  }

  function norm(v) {
    if (v === null || v === undefined) return "";
    return String(v).trim();
  }

  // ------------------------------
  // PowerShell equivalent:
  // $URL_EP = "https://helios.cohesity.com/v2/alerts?maxAlerts=...&alertTypes=1105&alertStates=kOpen,kNote&alertCategories=kNetworking"
  // $json = response.Content | ConvertFrom-Json
  // $ip = ($json.alerts.propertyList | where key -eq "node_ip" | select -first 1).value
  // ------------------------------
  var url =
    baseUrl +
    "/v2/alerts?" +
    buildQuery({
      maxAlerts: 5,
      alertTypes: "1105",
      alertStates: "kOpen,kNote",
      alertCategories: "kNetworking"
    });

  var dbg = await getJsonDebug(url, headers);

  console.log("=== Helios Alerts ===");
  console.log("AuthMode: " + authMode);
  console.log("URL: " + url);
  console.log("HTTP: " + dbg.status + " " + dbg.statusText);

  if (!dbg.ok) {
    console.log("Body snippet:\n" + dbg.textSnippet);
    throw new Error("Alerts call failed: HTTP " + dbg.status);
  }
  if (!dbg.json) {
    console.log("Body snippet:\n" + dbg.textSnippet);
    throw new Error("Alerts call returned non-JSON or JSON parse failed.");
  }

  var json = dbg.json;

  // alerts can be array or single object depending on API behavior
  var alertsRaw = json.alerts;
  var alerts = Array.isArray(alertsRaw) ? alertsRaw : (alertsRaw ? [alertsRaw] : []);

  // Extract node_ip from each alert.propertyList (array of {key,value})
  var ips = [];
  for (var a = 0; a < alerts.length; a++) {
    var alert = alerts[a] || {};
    var plist = alert.propertyList;

    if (!plist) continue;

    if (Array.isArray(plist)) {
      for (var p = 0; p < plist.length; p++) {
        var kv = plist[p] || {};
        if (norm(kv.key) === "node_ip") {
          var ip = norm(kv.value);
          if (ip) ips.push(ip);
          break; // same as Select-Object -First 1
        }
      }
    } else if (typeof plist === "object") {
      // Just in case propertyList comes as an object-map
      if (plist["node_ip"]) ips.push(norm(plist["node_ip"]));
    }
  }

  // unique
  var ipSet = {};
  for (var i = 0; i < ips.length; i++) ipSet[ips[i]] = true;
  var uniqueIps = Object.keys(ipSet).filter(function (x) { return x; }).sort();

  console.log("Alerts returned: " + alerts.length);
  console.log("node_ip extracted: " + uniqueIps.length);
  if (uniqueIps.length) console.log("IPs: " + uniqueIps.join(", "));
  else console.log("No node_ip found in alert.propertyList for these alerts.");

  // return both the debug and the extracted values
  return {
    authMode: authMode,
    requestedUrl: url,
    http: { ok: dbg.ok, status: dbg.status, statusText: dbg.statusText },
    alertsReturned: alerts.length,
    nodeIpCount: uniqueIps.length,
    nodeIps: uniqueIps,
    bodySnippet: dbg.textSnippet // helpful when node_ip still missing
  };
}
