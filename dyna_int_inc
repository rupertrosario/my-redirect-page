// Cohesity Helios - Get node_ip from alerts (direct conversion of your PowerShell)
// GET-only, safe.

export default async function () {
  const baseUrl = "https://helios.cohesity.com";

  // Paste your Helios API key here (you said you don't want vault)
  const apiKey = "PASTE_YOUR_API_KEY_HERE";

  // Same query as your PowerShell (change maxAlerts to 5 if needed)
  const qs = new URLSearchParams({
    maxAlerts: "5",                  // <-- change to 1/5/10
    alertTypes: "1105",
    alertStates: "kOpen,kNote",
    alertCategories: "kNetworking"
  }).toString();

  const url = `${baseUrl}/v2/alerts?${qs}`;

  const resp = await fetch(url, {
    method: "GET",
    headers: {
      accept: "application/json",
      apiKey: apiKey
    }
  });

  const text = await resp.text();
  if (!resp.ok) {
    throw new Error(`GET ${url} -> HTTP ${resp.status} ${text}`);
  }

  const json = text ? JSON.parse(text) : {};
  const alertsRaw = json.alerts;

  // In PS you used: $json.alerts.propertyList ...
  // But in reality alerts can be ARRAY or single OBJECT.
  const alerts = Array.isArray(alertsRaw) ? alertsRaw : (alertsRaw ? [alertsRaw] : []);

  // Extract node_ip exactly like your PS:
  // ($json.alerts.propertyList | where key == "node_ip" | select -first 1).value
  const ips = [];
  for (let i = 0; i < alerts.length; i++) {
    const a = alerts[i] || {};
    const propList = a.propertyList;

    if (!propList) continue;

    // propertyList is usually array of { key, value }
    if (Array.isArray(propList)) {
      const hit = propList.find(p => p && p.key === "node_ip");
      if (hit && hit.value) ips.push(String(hit.value).trim());
    } else if (typeof propList === "object") {
      // if propertyList ever comes as object map
      if (propList["node_ip"]) ips.push(String(propList["node_ip"]).trim());
    }
  }

  // unique
  const uniqueIps = Array.from(new Set(ips)).filter(Boolean);

  console.log("Helios alerts returned:", alerts.length);
  console.log("node_ip extracted:", uniqueIps.length, uniqueIps.join(", "));

  return {
    requestedUrl: url,
    alertCount: alerts.length,
    nodeIpCount: uniqueIps.length,
    nodeIps: uniqueIps
  };
}
