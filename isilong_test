fetch metrics, from: -2h
| filter metric in (
    "isilon.storagepool.bytes.used",
    "isilon.storagepool.bytes.hdd.used",
    "isilon.storagepool.bytes.sdd.used",
    "isilon.storagepool.bytes.total",
    "isilon.storagepool.bytes.hdd.total",
    "isilon.storagepool.bytes.sdd.total"
  )
| summarize last_val = last(value), by: {
    metric,
    dt.entity.isilon_storage_pool,
    `device.address`
  }
| pivot by: metric, value: last_val
| fieldsAdd
    used_bytes         = `isilon.storagepool.bytes.used`,
    used_hdd_bytes     = `isilon.storagepool.bytes.hdd.used`,
    used_sdd_bytes     = `isilon.storagepool.bytes.sdd.used`,
    total_bytes        = `isilon.storagepool.bytes.total`,
    total_hdd_bytes    = `isilon.storagepool.bytes.hdd.total`,
    total_sdd_bytes    = `isilon.storagepool.bytes.sdd.total`
| summarize
    used_bytes      = sum(used_bytes),
    used_hdd_bytes  = sum(used_hdd_bytes),
    used_sdd_bytes  = sum(used_sdd_bytes),
    total_bytes     = sum(total_bytes),
    total_hdd_bytes = sum(total_hdd_bytes),
    total_sdd_bytes = sum(total_sdd_bytes),
    by: {cluster = `device.address`}
| fieldsAdd
    total_TiB        = total_bytes      / 1099511627776.0,
    total_hdd_TiB    = total_hdd_bytes  / 1099511627776.0,
    total_sdd_TiB    = total_sdd_bytes  / 1099511627776.0,
    used_TiB         = used_bytes       / 1099511627776.0,
    used_hdd_TiB     = used_hdd_bytes   / 1099511627776.0,
    used_sdd_TiB     = used_sdd_bytes   / 1099511627776.0,
    used_pct         = 100.0 * used_bytes / total_bytes,
    used_hdd_pct     = 100.0 * used_hdd_bytes / total_hdd_bytes,
    used_sdd_pct     = 100.0 * used_sdd_bytes / total_sdd_bytes
| sort cluster
