// ðŸš€ Cohesity Helios Connectivity Test (Vault by ID â†’ by Name â†’ Manual Fallback)
import { credentialVaultClient } from "@dynatrace-sdk/client-classic-environment-v2";

export default async function () {
  const baseUrl = "https://helios.cohesity.com";
  const vaultId = "credentials_vault-312312";   // your stored credential ID
  const vaultName = "Cohesity_API_Key";         // your stored credential name
  let apiKey = null;
  let authMode = "vault";

  // Helper to fetch credential by name (list & match)
  async function tryGetByName(name) {
    try {
      const list = await credentialVaultClient.getCredentials();
      const found = list.credentials.find(c => c.name === name);
      if (!found) {
        console.log(`âŒ No credential found with name: ${name}`);
        return null;
      }
      const detail = await credentialVaultClient.getCredentialsDetails({ id: found.id });
      console.log(`âœ… Loaded API key from vault (by name): ${found.name}`);
      return detail.token;
    } catch (err) {
      console.log(`âš ï¸ Vault name lookup failed (${err.message || "unknown error"})`);
      return null;
    }
  }

  // 1ï¸âƒ£ Try vault by ID
  try {
    const vaultData = await credentialVaultClient.getCredentialsDetails({ id: vaultId });
    apiKey = vaultData?.token;
    console.log(`âœ… Loaded API key from vault (by ID): ${vaultData?.name || vaultId}`);
  } catch (err) {
    console.log(`âš ï¸ Vault ID fetch failed (${err.message || "unknown error"})`);
  }

  // 2ï¸âƒ£ Try vault by name (if ID not found or failed)
  if (!apiKey) {
    apiKey = await tryGetByName(vaultName);
    if (apiKey) authMode = "vault-name";
  }

  // 3ï¸âƒ£ Manual fallback
  if (!apiKey) {
    apiKey = "PASTE_YOUR_API_KEY_HERE"; // fallback key for testing
    authMode = "manual";
    console.log("âš ï¸ Using manual API key fallback");
  }

  // 4ï¸âƒ£ Make Helios API call
  const headers = { accept: "application/json", apiKey };
  const url = `${baseUrl}/v2/mcm/cluster-mgmt/info`;
  console.log(`ðŸŒ Calling: ${url}`);

  const resp = await fetch(url, { method: "GET", headers });
  if (resp.status !== 200) {
    const text = await resp.text();
    console.log(`âŒ API request failed (HTTP ${resp.status}) â†’ ${text}`);
    throw new Error(`Cluster list fetch failed (${resp.status})`);
  }

  const data = await resp.json();
  const clusters = data?.cohesityClusters || [];
  const clusterCount = clusters.length;

  // 5ï¸âƒ£ Log results
  console.log(`âœ… Successfully connected to Cohesity Helios`);
  console.log(`ðŸ“Š Total clusters found: ${clusterCount}`);
  if (clusterCount) {
    console.log("ðŸ§© Cluster names:");
    clusters.forEach(c => console.log(`  â€¢ ${c.clusterName}`));
  }

  // 6ï¸âƒ£ Return structured output
  return {
    authMode,                      // vault, vault-name, or manual
    clusterCount,
    clusterNames: clusters.map(c => c.clusterName) || []
  };
}
