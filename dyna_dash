// --- Dynatrace AppEngine runtime: can use execution.credentials.get() ---
import { execution } from '@dynatrace-sdk/automation-utils';

export default async function () {
  console.log("üîë Testing Cohesity Helios API key from Dynatrace vault...");

  // 1Ô∏è‚É£ Load API key securely from the Credentials Vault
  const creds = await execution.credentials.get('cohesity-helios-api-key');
  const apiKey = creds?.value || creds?.token || creds?.password;
  if (!apiKey) throw new Error("‚ùå API key not found in credentials vault");

  // 2Ô∏è‚É£ Simple GET test to confirm connectivity
  const url = "https://helios.cohesity.com/v2/mcm/cluster-mgmt/info";
  const headers = { accept: "application/json", apiKey };

  const resp = await fetch(url, { headers });
  console.log(`‚û°Ô∏è HTTP status: ${resp.status}`);
  if (resp.status !== 200) throw new Error(`‚ùå API key test failed (HTTP ${resp.status})`);

  // 3Ô∏è‚É£ Parse JSON response
  const data = await resp.json();
  const clusters = data?.cohesityClusters?.map(c => c.ClusterName) || [];
  console.log(`‚úÖ API key works! Found ${clusters.length} cluster(s): ${clusters.join(", ")}`);

  // 4Ô∏è‚É£ Return result for workflow output
  return { success: true, clusterCount: clusters.length, clusters };
}
