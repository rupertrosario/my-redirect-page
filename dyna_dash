// --- Test Cohesity Helios API key with a simple GET call ---

// 1️⃣ Load your credential from the Dynatrace vault
const creds = await execution.credentials.get('cohesity-helios-api-key');
const apiKey = creds?.value || creds?.token || creds?.password;

if (!apiKey) {
  throw new Error("❌ API key not found in Dynatrace credentials vault");
}

// 2️⃣ Define endpoint and headers
const url = "https://helios.cohesity.com/v2/mcm/cluster-mgmt/info";
const headers = { accept: "application/json", apiKey };

// 3️⃣ Perform the GET request
const response = await http.get(url, { headers });
console.log(`➡️ HTTP status: ${response.status}`);

// 4️⃣ Handle response
if (response.status !== 200) {
  throw new Error(`❌ API key test failed (HTTP ${response.status})`);
}

const clusters = response.data?.cohesityClusters?.map(c => c.ClusterName) || [];
console.log(`✅ API key works! Found ${clusters.length} cluster(s): ${clusters.join(", ")}`);

// 5️⃣ Return result to the workflow output
return { success: true, clusterCount: clusters.length, clusters };
