export default async function () {
  log.info("🔑 Testing Cohesity Helios API key connectivity...");

  // Load credential from Dynatrace vault
  const creds = await execution.credentials.get('cohesity-helios-api-key');
  const apiKey = creds?.value || creds?.token || creds?.password;

  if (!apiKey) throw new Error("❌ API key not found in Dynatrace credentials vault");

  // Simple GET test to verify the key
  const url = "https://helios.cohesity.com/v2/mcm/cluster-mgmt/info";
  const headers = { accept: "application/json", apiKey };

  const response = await http.get(url, { headers });

  log.info(`➡️ HTTP status: ${response.status}`);
  if (response.status !== 200) throw new Error(`❌ API key test failed (${response.status})`);

  const clusters = response.data?.cohesityClusters?.map(c => c.ClusterName) || [];
  log.info(`✅ API key works! Found ${clusters.length} cluster(s): ${clusters.join(", ")}`);

  return { success: true, clusterCount: clusters.length, clusters };
}
