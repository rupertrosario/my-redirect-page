// One-step Dynatrace Workflow JS: Cohesity capacity only (no garbage) + metrics ingest
import { metricsClient } from '@dynatrace-sdk/client-classic-environment-v2';

export default async function () {
  console.log("ğŸš€ Cohesity Helios â€“ READ-ONLY (capacity only)");

  // ğŸ”‘ Inline Helios key
  const apiKey  = "PASTE_YOUR_API_KEY_HERE";
  const baseUrl = "https://helios.cohesity.com";
  const oneTiB  = 1099511627776;
  const headers = { accept: "application/json", apiKey };

  // 1) Inventory
  const listUrl = `${baseUrl}/v2/mcm/cluster-mgmt/info`;
  const listResp = await fetch(listUrl, { method: "GET", headers });
  if (listResp.status !== 200) throw new Error(`âŒ Cluster list failed (HTTP ${listResp.status})`);

  const data = await listResp.json();
  const clusters = data?.cohesityClusters || [];
  if (clusters.length === 0) {
    console.log("âš ï¸ No clusters returned.");
    return { clusters: [] };
  }

  const results = [];
  const lines   = [];

  // 2) Capacity per cluster (no garbage)
  for (const { clusterName, clusterId } of clusters) {
    const h = { ...headers, accessClusterId: String(clusterId) };
    console.log(`ğŸ“Š Reading capacity for ${clusterName} (ID ${clusterId})`);

    const capUrl  = `${baseUrl}/irisservices/api/v1/public/stats/storage`;
    const capResp = await fetch(capUrl, { method: "GET", headers: h });
    if (capResp.status !== 200) {
      console.log(`âš ï¸ Capacity GET failed for ${clusterName} (HTTP ${capResp.status})`);
      continue;
    }

    const s = await capResp.json();
    const totalTiB = +(s.totalCapacityBytes  / oneTiB).toFixed(2);
    const usedTiB  = +(s.localUsageBytes     / oneTiB).toFixed(2);
    const availTiB = +(s.localAvailableBytes / oneTiB).toFixed(2);
    const consumed = +((s.localUsageBytes / s.totalCapacityBytes) * 100).toFixed(2);

    results.push({ clusterName, clusterId, totalTiB, usedTiB, availTiB, consumedPercent: consumed });

    const dims = `clusterName="${String(clusterName).replace(/"/g, '\\"')}",clusterId="${clusterId}"`;
    lines.push(
      `cohesity.capacity.total.tib,${dims} ${totalTiB}`,
      `cohesity.capacity.used.tib,${dims} ${usedTiB}`,
      `cohesity.capacity.avail.tib,${dims} ${availTiB}`,
      `cohesity.capacity.consumed.percent,${dims} ${consumed}`
    );

    console.log(`âœ… ${clusterName}: ${consumed}% used (${usedTiB}/${totalTiB} TiB)`);
  }

  // 3) Ingest to Dynatrace
  if (lines.length > 0) {
    console.log(`ğŸ“¡ Ingesting ${lines.length} lines to Dynatraceâ€¦`);
    await metricsClient.ingest({ body: lines.join('\n') });
    console.log("âœ… Metrics ingested.");
  } else {
    console.log("â„¹ï¸ No metrics to ingest.");
  }

  console.log("ğŸ“„ Summary:");
  console.log(JSON.stringify(results, null, 2));
  return { clusters: results };
}
