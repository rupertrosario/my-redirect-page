# --- robust epoch -> UTC converter (ms first; fallback to µs) ---
function Convert-ToUtcFromEpoch($v) {
    if ($null -eq $v -or $v -eq 0) { return $null }
    try {
        return [DateTimeOffset]::FromUnixTimeMilliseconds([int64]$v).UtcDateTime   # milliseconds path
    } catch {
        return [DateTimeOffset]::FromUnixTimeMilliseconds([int64]([double]$v / 1000)).UtcDateTime  # microseconds
    }
}

# --- SETTINGS ---
$environments = @('kOracle','kSQL','kVMware')   # add/remove as needed
$reportDate   = Get-Date -Format "yyyy-MM-dd_HHmm"
$excelFile    = "BackupFailures_AllClusters_$reportDate.xlsx"
$firstSheet   = $true

# one Excel per run; delete if you want a fresh file
if (Test-Path $excelFile) { Remove-Item $excelFile -Force }

foreach ($env in $environments) {
    Write-Host "`n=== Environment: $env ==="
    $globalFailures = @()

    foreach ($cluster in $clusters) {
        $clusterId   = $cluster.id
        $clusterName = $cluster.name
        $pgUrl       = "https://your-api/clusters/$clusterId/protection-groups"

        # Your existing call; normalize whether Invoke-RestMethod returned parsed JSON or a .Content string
        $respPG = Invoke-RestMethod -Uri $pgUrl -Headers $headers -Method Get
        $pgResponse = if ($respPG -and $respPG.PSObject.Properties['Content']) {
            if ($respPG.Content) { $respPG.Content | ConvertFrom-Json } else { $respPG }
        } else { $respPG }

        $pgs = $pgResponse.protectionGroups | Where-Object { $_.environment -eq $env }
        if (-not $pgs) { continue }

        foreach ($pg in $pgs) {
            $pgId   = $pg.id
            $pgName = $pg.name
            $runUrl = "https://your-api/protection-groups/$pgId/runs?numRuns=10"

            try {
                $respRuns = Invoke-RestMethod -Uri $runUrl -Headers $headers -Method Get
                $runs = if ($respRuns -and $respRuns.runs) { $respRuns.runs } else { @() }
                if (-not $runs) { continue }

                # flatten: only consider objects with non-null failedAttempts, remove nulls, and exclude kPhysical
                $flatRuns = foreach ($run in $runs) {
                    if ($run.localBackupInfo -and $run.objects) {
                        foreach ($info in $run.localBackupInfo) {
                            foreach ($obj in $run.objects) {
                                if ($obj.object.environment -ne "kPhysical" -and $obj.localSnapshotInfo.failedAttempts -ne $null -and $obj.localSnapshotInfo.failedAttempts.Count -gt 0) {
                                    foreach ($fail in $obj.localSnapshotInfo.failedAttempts | Where-Object { $_ -ne $null -and $_.errorMsg -ne $null -and $_.errorMsg -ne "" }) {
                                        [pscustomobject]@{
                                            RunType         = $info.runType
                                            Status          = $info.status
                                            Message         = $fail.errorMsg
                                            StartTimeUsecs  = $info.startTimeUsecs
                                            EndTimeUsecs    = $info.endTimeUsecs
                                            Cluster         = $clusterName
                                            ProtectionGroup = $pgName
                                            ObjectName      = $obj.object.name
                                        }
                                    }
                                }
                            }
                        }
                    }
                }

                if (-not $flatRuns) { continue }

                # only include failures that have no later success for the same RunType
                $grouped = $flatRuns | Group-Object RunType
                foreach ($g in $grouped) {
                    $latestFailed = $g.Group | Where-Object { $_.Status -eq "Failed" } |
                                    Sort-Object EndTimeUsecs -Descending | Select-Object -First 1
                    if ($null -ne $latestFailed) {
                        $hasLaterSuccess = $g.Group | Where-Object {
                            $_.Status -eq "Succeeded" -and $_.StartTimeUsecs -gt $latestFailed.EndTimeUsecs
                        }
                        if (-not $hasLaterSuccess) {
                            $estZone = [System.TimeZoneInfo]::FindSystemTimeZoneById("Eastern Standard Time")
                            $startUtc = Convert-ToUtcFromEpoch $latestFailed.StartTimeUsecs
                            $endUtc   = Convert-ToUtcFromEpoch $latestFailed.EndTimeUsecs

                            $globalFailures += [pscustomobject]@{
                                Cluster         = $latestFailed.Cluster
                                ProtectionGroup = $latestFailed.ProtectionGroup
                                ObjectName      = $latestFailed.ObjectName
                                RunType         = $latestFailed.RunType
                                Status          = $latestFailed.Status
                                Message         = $latestFailed.Message
                                StartTime       = if ($startUtc) { [System.TimeZoneInfo]::ConvertTimeFromUtc($startUtc, $estZone).ToString("dd/MM/yyyy HH:mm:ss") } else { "" }
                                EndTime         = if ($endUtc) { [System.TimeZoneInfo]::ConvertTimeFromUtc($endUtc, $estZone).ToString("dd/MM/yyyy HH:mm:ss") } else { "" }
                            }
                        }
                    }
                }
            } catch {
                Write-Warning "Failed to get runs for PG $pgName ($pgId) on $clusterName"
            }
        }
    }

    # Export a worksheet per environment
    if ($globalFailures.Count -gt 0) {
        $sheet = switch ($env) {
            'kOracle' { 'Oracle' }
            'kSQL'    { 'SQL' }
            'kVMware' { 'VMware' }
            default   { $env }
        }

        if ($firstSheet) {
            $globalFailures | Export-Excel -Path $excelFile -WorksheetName $sheet -AutoSize
            $firstSheet = $false
        } else {
            $globalFailures | Export-Excel -Path $excelFile -WorksheetName $sheet -AutoSize -Append
        }

        Write-Host "✔ Exported $($globalFailures.Count) rows to worksheet '$sheet'"
    } else {
        Write-Host "No unresolved failures found for $env"
    }
}

Write-Host "`nSaved Excel report with per-environment tabs: $excelFile"


if ($obj.object.environment -ne "kPhysical" -and $obj.localSnapshotInfo -and $obj.localSnapshotInfo.failedAttempts -and $obj.localSnapshotInfo.failedAttempts.Count -gt 0) {
    Write-Host "Raw object dump for debugging:" -ForegroundColor Cyan
    $obj | Format-List *
    
    foreach ($fail in $obj.localSnapshotInfo.failedAttempts | Where-Object { $_ -ne $null -and $_.message -ne $null -and $_.message -ne "" }) {
        [pscustomobject]@{
            Cluster         = $clusterName
            ProtectionGroup = $pgName
            ObjectName      = $obj.object.name   # should align with DB name
            Status          = $info.status
            RunType         = $info.runType
            Message         = $fail.message
        } | Format-Table -AutoSize
    }
}

