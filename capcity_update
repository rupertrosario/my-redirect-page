function Invoke-HeliosJson {
  param(
    [Parameter(Mandatory)] [string]$Uri,
    [Parameter(Mandatory)] [hashtable]$Headers,
    [object]$Body = $null
  )
  try {
    $resp = Invoke-WebRequest -Method Get -Uri $Uri -Headers $Headers -Body $Body -ErrorAction Stop
    return ($resp.Content | ConvertFrom-Json)
  } catch {
    $code = $null
    try { $code = [int]$_.Exception.Response.StatusCode } catch {}
    if ($code -in 502,503,504) { return $null }   # silent gateway/down
    return $null                                   # silent for others too
  }
}

$json  = Invoke-HeliosJson -Uri $URL1 -Headers $headers -Body $body
$json1 = Invoke-HeliosJson -Uri $URL2 -Headers $headers

if (-not $json -or -not $json1) {
  $results += [pscustomobject]@{
    Cluster                  = $cluster_name
    Grabage_Data_In_GB       = "NO_DATA"
    Grabage_Data_In_TB       = "NO_DATA"
    Total_Capacity_Bytes_TB  = $null
    Local_Usage_Bytes_TB     = $null
    Local_Available_Bytes_TB = $null
    ConsumedPct              = -1
    Consumed                 = "NO_DATA"
  }
  continue
}

# --- keep your existing line (no change) ---
$Consumed = [math]::Round(($json1.localUsageBytes / $json1.totalCapacityBytes) * 100, 1)

foreach ($node in $json2) {
  $bytes = $node.data.int64Value
  $epoch = $node.timestampMsecs
  $epochtime = ([datetime]'1970-01-01 00:00:00').AddMilliseconds($epoch)
  $datetime  = $epochtime.ToString("MM/dd/yyy HH:mm:ss")
$gb = [math]::Round($bytes / 1e9, 2)   # decimal GB
$tb = [math]::Round($bytes / 1e12, 4)  # decimal TB

  $results += [PSCustomObject]@{
    Cluster                  = $cluster_name
    #DateTime                = $datetime
    Grabage_Data_In_GB        = "$gb GB"
    Grabage_Data_In_TB        = "$tb TB"
Total_Capacity_Bytes_TB   = [math]::Round($json1.totalCapacityBytes / 1e12, 2)
Local_Usage_Bytes_TB      = [math]::Round($json1.localUsageBytes / 1e12, 2)
Local_Available_Bytes_TB  = [math]::Round($json1.localAvailableBytes / 1e12, 2)

    # numeric for sorting/math + display string
    ConsumedPct               = [double]$Consumed
    Consumed                  = ("{0:N1}%" -f $Consumed)
  }
}

# --- FULL replacement for your PercentVal parsing + sort + display (matches your screenshot pipeline) ---
$results |
  Select-Object *, @{ Name='PercentVal'; Expression = { $_.ConsumedPct } } |
  Sort-Object PercentVal -Descending |
  Format-Table Cluster, Grabage_Data_In_GB, Grabage_Data_In_TB,
               Total_Capacity_Bytes_TiB, Local_Usage_Bytes_TiB, Local_Available_Bytes_TiB,
               @{Label='Consumed'; Expression={$_.Consumed}}

# --- OPTIONAL export (export sorted view, not raw $results) ---
# $results |
#   Select-Object *, @{ Name='PercentVal'; Expression = { $_.ConsumedPct } } |
#   Sort-Object PercentVal -Descending |
#   Export-Csv -Path "H:\Cohesity_API\Logs\SQL_Alert.csv" -NoTypeInformation -Encoding UTF8
