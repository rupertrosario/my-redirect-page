# =====================================================================
# Cohesity Backup Failures ‚Äì Multi-Cluster (Helios)
# Menu-driven | Silent/Verbose | Fallback OFF (only object failedAttempts[])
# Envs: Oracle, SQL, Physical, NAS, HyperV, Acropolis, RemoteAdapter
# Extra: Consolidated report-only (silent), 30-day log cleanup, Exit option
# =====================================================================

# ---------- Settings ----------
$logDirectory = "X:\PowerShell\Data\Cohesity\BackupFailures"
$apikeypath   = "X:\PowerShell\Cohesity_API_Scripts\DO_NOT_Delete\apikey.txt"
$baseUrl      = "https://helios.cohesity.com"
$tz           = [System.TimeZoneInfo]::FindSystemTimeZoneById("Eastern Standard Time")

# ---------- Ensure folder & cleanup ----------
if (-not (Test-Path -Path $logDirectory -PathType Container)) {
    New-Item -Path $logDirectory -ItemType Directory | Out-Null
}
# delete files older than 30 days
Get-ChildItem -Path $logDirectory -File -ErrorAction SilentlyContinue |
    Where-Object { $_.LastWriteTime -lt (Get-Date).AddDays(-30) } |
    Remove-Item -Force -ErrorAction SilentlyContinue

# keep at most 50 most-recent files
$files = Get-ChildItem -Path $logDirectory -File -ErrorAction SilentlyContinue | Sort-Object CreationTime -Descending
if ($files.Count -gt 50) {
    $files | Select-Object -Skip 50 | Remove-Item -Force -ErrorAction SilentlyContinue
}

# ---------- API key ----------
if (-not (Test-Path $apikeypath)) { throw "API key file not found: $apikeypath" }
$apiKey = (Get-Content -Path $apikeypath -Raw).Trim()
$commonHeaders = @{ "apiKey" = $apiKey }

# ---------- Helpers ----------
function Convert-ToUtcFromEpoch($v){
    if ($null -eq $v -or $v -eq 0) { return $null }
    try { [DateTimeOffset]::FromUnixTimeMilliseconds([int64]([double]$v/1000)).UtcDateTime }
    catch { [DateTimeOffset]::FromUnixTimeMilliseconds([int64]$v).UtcDateTime }
}
function ToLocal($usecs){
    $utc = Convert-ToUtcFromEpoch $usecs
    if ($null -eq $utc) { return $null }
    [System.TimeZoneInfo]::ConvertTimeFromUtc($utc, $tz)
}
function NameOfCluster($c){
    ($c.name,$c.clusterName,$c.displayName | Where-Object { $_ -and $_.Trim() } | Select-Object -First 1) `
        ?? "Unknown-$($c.clusterId)"
}
function SafeCsv($path){
    param($rows)
    if($rows -and $rows.Count -gt 0){
        $rows | Export-Csv -Path $path -NoTypeInformation -Encoding utf8
        return $true
    }
    return $false
}
function Write-VerboseIf { param([bool]$cond,[string]$msg,[string]$color="Gray")
    if($script:VerboseMode -and $cond){ Write-Host $msg -ForegroundColor $color }
}

# ---------- Clusters ----------
$response = Invoke-WebRequest -Uri "$baseUrl/v2/mcm/cluster-mgmt/info" -Headers $commonHeaders -Method Get
$json_clu = ($response.Content | ConvertFrom-Json).cohesityClusters
if (-not $json_clu) { throw "No clusters returned from Helios." }

# ---------- Core collectors (fallback OFF) ----------
function Collect-Oracle {
    # DB-level + host-level (no DBs discovered) for Oracle
    $label = "Oracle"
    $filter = "kOracle"
    $global = @()

    foreach($clus in $json_clu){
        $cName = NameOfCluster $clus
        $headers = @{ apiKey=$apiKey; accessClusterId=$clus.clusterId }

        # PGs
        try {
            $pgs = ((Invoke-WebRequest -Uri "$baseUrl/v2/data-protect/protection-groups" -Headers $headers -Body @{
                environments=$filter; isDeleted="False"; isPaused="False"; isActive="True"
            } -Method Get).Content | ConvertFrom-Json).protectionGroups
        } catch { continue }
        if(-not $pgs){ continue }

        foreach($pg in $pgs){
            $pgId=$pg.id; $pgName=$pg.name

            # Runs (latest per runType)
            try {
                $runsJson = (Invoke-WebRequest -Uri "$baseUrl/v2/data-protect/protection-groups/$pgId/runs" -Headers $headers -Body @{
                    environments=$filter; numRuns="10"; excludeNonRestorableRuns="False"; includeObjectDetails="True"
                } -Method Get) | ConvertFrom-Json
            } catch { continue }
            if(-not $runsJson.runs){ continue }

            $runs = $runsJson.runs
            $runTypes = $runs.localBackupInfo.runType | Select-Object -Unique
            foreach($rt in $runTypes){
                $latest = $runs | Where-Object { $_.localBackupInfo[0].runType -eq $rt } |
                          Sort-Object { $_.localBackupInfo[0].endTimeUsecs } -Descending | Select-Object -First 1
                if(-not $latest){ continue }
                $info = $latest.localBackupInfo[0]
                if($info.status -in @("Succeeded","SucceededWithWarning")){ continue }

                $start = ToLocal $info.startTimeUsecs
                $end   = ToLocal $info.endTimeUsecs

                if($latest.objects){
                    $dbObjs   = $latest.objects | Where-Object { $_.object.objectType -eq 'kDatabase' }
                    $hostObjs = $latest.objects | Where-Object { $_.object.objectType -eq 'kHost' -or $_.object.environment -eq 'kPhysical' }

                    # Map id->name (for parent host lookup)
                    $idToName = @{}
                    foreach($o in $latest.objects){ if($o.object.id){ $idToName[[string]$o.object.id]=$o.object.name } }

                    # DB-level failures
                    foreach($db in $dbObjs){
                        $fa = $db.localSnapshotInfo.failedAttempts
                        if(-not $fa){ continue }
                        $parent = $null
                        if($db.object.sourceId){ $idToName.TryGetValue([string]$db.object.sourceId, [ref]$parent) | Out-Null }
                        foreach($f in $fa){
                            $msg = ($f.message -replace '[\r\n]+',' ' -replace ',',' ' -replace '"','''').Trim()
                            $global += [pscustomobject]@{
                                Cluster         = $cName
                                ProtectionGroup = $pgName
                                Environment     = $label
                                RunType         = $info.runType
                                Hosts           = $parent
                                DatabaseName    = $db.object.name
                                StartTime       = $start
                                EndTime         = $end
                                FailedMessage   = $msg
                            }
                        }
                    }

                    # Host-level failures (no DBs discovered but host has failedAttempts)
                    foreach($h in $hostObjs){
                        $fa = $h.localSnapshotInfo.failedAttempts
                        if(-not $fa){ continue }
                        foreach($f in $fa){
                            $msg = ($f.message -replace '[\r\n]+',' ' -replace ',',' ' -replace '"','''').Trim()
                            $global += [pscustomobject]@{
                                Cluster         = $cName
                                ProtectionGroup = $pgName
                                Environment     = $label
                                RunType         = $info.runType
                                Hosts           = $h.object.name
                                DatabaseName    = "No DBs Found (Host-Level Failure)"
                                StartTime       = $start
                                EndTime         = $end
                                FailedMessage   = $msg
                            }
                        }
                    }
                }
            }
        }
    }

    # Dedup & sort
    if($global.Count -gt 0){
        $global = $global | Group-Object {
            "$($_.Cluster)|$($_.ProtectionGroup)|$($_.RunType)|$($_.Hosts)|$($_.DatabaseName)|$($_.FailedMessage)|$($_.EndTime)"
        } | ForEach-Object { $_.Group | Sort-Object EndTime -Descending | Select-Object -First 1 }
        $out = $global | Sort-Object Cluster,ProtectionGroup,EndTime -Descending
        $csv = Join-Path $logDirectory ("BackupFailures_Oracle_AllClusters_{0}.csv" -f (Get-Date -Format "yyyyMMdd_HHmm"))
        SafeCsv -path $csv -rows $out | Out-Null
        return [pscustomobject]@{ Label="Oracle"; Rows=$out; Csv=$csv }
    }
    return [pscustomobject]@{ Label="Oracle"; Rows=@(); Csv=$null }
}

function Collect-SQL {
    # mirrors Oracle (DB + host-level)
    $label = "SQL"
    $filter = "kSQL"
    $global = @()

    foreach($clus in $json_clu){
        $cName = NameOfCluster $clus
        $headers = @{ apiKey=$apiKey; accessClusterId=$clus.clusterId }

        try {
            $pgs = ((Invoke-WebRequest -Uri "$baseUrl/v2/data-protect/protection-groups" -Headers $headers -Body @{
                environments=$filter; isDeleted="False"; isPaused="False"; isActive="True"
            } -Method Get).Content | ConvertFrom-Json).protectionGroups
        } catch { continue }
        if(-not $pgs){ continue }

        foreach($pg in $pgs){
            $pgId=$pg.id; $pgName=$pg.name

            try {
                $runsJson = (Invoke-WebRequest -Uri "$baseUrl/v2/data-protect/protection-groups/$pgId/runs" -Headers $headers -Body @{
                    environments=$filter; numRuns="10"; excludeNonRestorableRuns="False"; includeObjectDetails="True"
                } -Method Get) | ConvertFrom-Json
            } catch { continue }
            if(-not $runsJson.runs){ continue }

            $runs = $runsJson.runs
            $runTypes = $runs.localBackupInfo.runType | Select-Object -Unique
            foreach($rt in $runTypes){
                $latest = $runs | Where-Object { $_.localBackupInfo[0].runType -eq $rt } |
                          Sort-Object { $_.localBackupInfo[0].endTimeUsecs } -Descending | Select-Object -First 1
                if(-not $latest){ continue }
                $info = $latest.localBackupInfo[0]
                if($info.status -in @("Succeeded","SucceededWithWarning")){ continue }

                $start = ToLocal $info.startTimeUsecs
                $end   = ToLocal $info.endTimeUsecs

                if($latest.objects){
                    $dbObjs   = $latest.objects | Where-Object { $_.object.objectType -eq 'kDatabase' }
                    $hostObjs = $latest.objects | Where-Object { $_.object.objectType -eq 'kHost' -or $_.object.environment -eq 'kSQL' }

                    $idToName = @{}
                    foreach($o in $latest.objects){ if($o.object.id){ $idToName[[string]$o.object.id]=$o.object.name } }

                    foreach($db in $dbObjs){
                        $fa = $db.localSnapshotInfo.failedAttempts
                        if(-not $fa){ continue }
                        $parent = $null
                        if($db.object.sourceId){ $idToName.TryGetValue([string]$db.object.sourceId,[ref]$parent)|Out-Null }
                        foreach($f in $fa){
                            $msg = ($f.message -replace '[\r\n]+',' ' -replace ',',' ' -replace '"','''').Trim()
                            $global += [pscustomobject]@{
                                Cluster         = $cName
                                ProtectionGroup = $pgName
                                Environment     = $label
                                RunType         = $info.runType
                                Hosts           = $parent
                                DatabaseName    = $db.object.name
                                StartTime       = $start
                                EndTime         = $end
                                FailedMessage   = $msg
                            }
                        }
                    }

                    foreach($h in $hostObjs){
                        $fa = $h.localSnapshotInfo.failedAttempts
                        if(-not $fa){ continue }
                        foreach($f in $fa){
                            $msg = ($f.message -replace '[\r\n]+',' ' -replace ',',' ' -replace '"','''').Trim()
                            $global += [pscustomobject]@{
                                Cluster         = $cName
                                ProtectionGroup = $pgName
                                Environment     = $label
                                RunType         = $info.runType
                                Hosts           = $h.object.name
                                DatabaseName    = "No DBs Found (Host-Level Failure)"
                                StartTime       = $start
                                EndTime         = $end
                                FailedMessage   = $msg
                            }
                        }
                    }
                }
            }
        }
    }

    if($global.Count -gt 0){
        $global = $global | Group-Object {
            "$($_.Cluster)|$($_.ProtectionGroup)|$($_.RunType)|$($_.Hosts)|$($_.DatabaseName)|$($_.FailedMessage)|$($_.EndTime)"
        } | ForEach-Object { $_.Group | Sort-Object EndTime -Descending | Select-Object -First 1 }
        $out = $global | Sort-Object Cluster,ProtectionGroup,EndTime -Descending
        $csv = Join-Path $logDirectory ("BackupFailures_SQL_AllClusters_{0}.csv" -f (Get-Date -Format "yyyyMMdd_HHmm"))
        SafeCsv -path $csv -rows $out | Out-Null
        return [pscustomobject]@{ Label="SQL"; Rows=$out; Csv=$csv }
    }
    return [pscustomobject]@{ Label="SQL"; Rows=@(); Csv=$null }
}

function Collect-Physical {
    $label="Physical"
    $filter="kPhysical"
    $global=@()

    foreach($clus in $json_clu){
        $cName = NameOfCluster $clus
        $headers = @{ apiKey=$apiKey; accessClusterId=$clus.clusterId }

        try {
            $pgs = ((Invoke-WebRequest -Uri "$baseUrl/v2/data-protect/protection-groups" -Headers $headers -Body @{
                environments=$filter; isDeleted="False"; isPaused="False"; isActive="True"
            } -Method Get).Content | ConvertFrom-Json).protectionGroups
        } catch { continue }
        if(-not $pgs){ continue }

        foreach($pg in $pgs){
            $pgId=$pg.id;$pgName=$pg.name
            try {
                $runsJson = (Invoke-WebRequest -Uri "$baseUrl/v2/data-protect/protection-groups/$pgId/runs" -Headers $headers -Body @{
                    environments=$filter; numRuns="10"; excludeNonRestorableRuns="False"; includeObjectDetails="True"
                } -Method Get) | ConvertFrom-Json
            } catch { continue }
            if(-not $runsJson.runs){ continue }

            $runs = $runsJson.runs | Sort-Object { $_.localBackupInfo[0].endTimeUsecs } -Descending
            $latest = $runs | Select-Object -First 1
            if(-not $latest){ continue }
            $info = $latest.localBackupInfo[0]
            if($info.status -in @("Succeeded","SucceededWithWarning")){ continue }

            $start = ToLocal $info.startTimeUsecs
            $end   = ToLocal $info.endTimeUsecs

            if($latest.objects){
                $hosts = $latest.objects | Where-Object { $_.object.objectType -eq 'kHost' -and $_.object.environment -eq 'kPhysical' }
                foreach($h in $hosts){
                    $fa = $h.localSnapshotInfo.failedAttempts
                    if(-not $fa){ continue }
                    foreach($f in $fa){
                        $msg = ($f.message -replace '[\r\n]+',' ' -replace ',',' ' -replace '"','''').Trim()
                        $global += [pscustomobject]@{
                            Cluster         = $cName
                            ProtectionGroup = $pgName
                            Environment     = $label
                            RunType         = $info.runType
                            Name            = $h.object.name
                            StartTime       = $start
                            EndTime         = $end
                            FailedMessage   = $msg
                        }
                    }
                }
            }
        }
    }

    if($global.Count -gt 0){
        $global = $global | Group-Object {
            "$($_.Cluster)|$($_.ProtectionGroup)|$($_.RunType)|$($_.Name)|$($_.FailedMessage)|$($_.EndTime)"
        } | ForEach-Object { $_.Group | Sort-Object EndTime -Descending | Select-Object -First 1 }
        $out = $global | Sort-Object Cluster,ProtectionGroup,EndTime -Descending
        $csv = Join-Path $logDirectory ("BackupFailures_Physical_AllClusters_{0}.csv" -f (Get-Date -Format "yyyyMMdd_HHmm"))
        SafeCsv -path $csv -rows $out | Out-Null
        return [pscustomobject]@{ Label="Physical"; Rows=$out; Csv=$csv }
    }
    return [pscustomobject]@{ Label="Physical"; Rows=@(); Csv=$null }
}

function Collect-NAS {
    $label="NAS"
    $filter="kGenericNas,kIsilon"
    $global=@()

    foreach($clus in $json_clu){
        $cName = NameOfCluster $clus
        $headers = @{ apiKey=$apiKey; accessClusterId=$clus.clusterId }

        try {
            $pgs = ((Invoke-WebRequest -Uri "$baseUrl/v2/data-protect/protection-groups" -Headers $headers -Body @{
                environments=$filter; isDeleted="False"; isPaused="False"; isActive="True"
            } -Method Get).Content | ConvertFrom-Json).protectionGroups
        } catch { continue }
        if(-not $pgs){ continue }

        foreach($pg in $pgs){
            $pgId=$pg.id;$pgName=$pg.name
            try {
                $runsJson = (Invoke-WebRequest -Uri "$baseUrl/v2/data-protect/protection-groups/$pgId/runs" -Headers $headers -Body @{
                    environments=$filter; numRuns="10"; excludeNonRestorableRuns="False"; includeObjectDetails="True"
                } -Method Get) | ConvertFrom-Json
            } catch { continue }
            if(-not $runsJson.runs){ continue }

            $runs = $runsJson.runs
            $runTypes = $runs.localBackupInfo.runType | Select-Object -Unique
            foreach($rt in $runTypes){
                $latest = $runs | Where-Object { $_.localBackupInfo[0].runType -eq $rt } |
                          Sort-Object { $_.localBackupInfo[0].endTimeUsecs } -Descending | Select-Object -First 1
                if(-not $latest){ continue }
                $info = $latest.localBackupInfo[0]
                if($info.status -in @("Succeeded","SucceededWithWarning")){ continue }

                $start = ToLocal $info.startTimeUsecs
                $end   = ToLocal $info.endTimeUsecs

                if($latest.objects){
                    $shares = $latest.objects | Where-Object { $_.object.objectType -eq 'kHost' -or $_.object.objectType -eq 'kGenericNas' }
                    foreach($s in $shares){
                        $fa = $s.localSnapshotInfo.failedAttempts
                        if(-not $fa){ continue }
                        foreach($f in $fa){
                            $msg = ($f.message -replace '[\r\n]+',' ' -replace ',',' ' -replace '"','''').Trim()
                            $global += [pscustomobject]@{
                                Cluster         = $cName
                                ProtectionGroup = $pgName
                                Environment     = $label
                                RunType         = $info.runType
                                Name            = $s.object.name
                                StartTime       = $start
                                EndTime         = $end
                                FailedMessage   = $msg
                            }
                        }
                    }
                }
            }
        }
    }

    if($global.Count -gt 0){
        $global = $global | Group-Object {
            "$($_.Cluster)|$($_.ProtectionGroup)|$($_.RunType)|$($_.Name)|$($_.FailedMessage)|$($_.EndTime)"
        } | ForEach-Object { $_.Group | Sort-Object EndTime -Descending | Select-Object -First 1 }
        $out = $global | Sort-Object Cluster,ProtectionGroup,EndTime -Descending
        $csv = Join-Path $logDirectory ("BackupFailures_NAS_AllClusters_{0}.csv" -f (Get-Date -Format "yyyyMMdd_HHmm"))
        SafeCsv -path $csv -rows $out | Out-Null
        return [pscustomobject]@{ Label="NAS"; Rows=$out; Csv=$csv }
    }
    return [pscustomobject]@{ Label="NAS"; Rows=@(); Csv=$null }
}

function Collect-HyperV {
    $label="HyperV"
    $filter="kHyperV"
    $global=@()

    foreach($clus in $json_clu){
        $cName = NameOfCluster $clus
        $headers = @{ apiKey=$apiKey; accessClusterId=$clus.clusterId }

        try {
            $pgs = ((Invoke-WebRequest -Uri "$baseUrl/v2/data-protect/protection-groups" -Headers $headers -Body @{
                environments=$filter; isDeleted="False"; isPaused="False"; isActive="True"
            } -Method Get).Content | ConvertFrom-Json).protectionGroups
        } catch { continue }
        if(-not $pgs){ continue }

        foreach($pg in $pgs){
            $pgId=$pg.id;$pgName=$pg.name
            try {
                $runsJson = (Invoke-WebRequest -Uri "$baseUrl/v2/data-protect/protection-groups/$pgId/runs" -Headers $headers -Body @{
                    environments=$filter; numRuns="10"; excludeNonRestorableRuns="False"; includeObjectDetails="True"
                } -Method Get) | ConvertFrom-Json
            } catch { continue }
            if(-not $runsJson.runs){ continue }

            $runs = $runsJson.runs
            $runTypes = $runs.localBackupInfo.runType | Select-Object -Unique
            foreach($rt in $runTypes){
                $latest = $runs | Where-Object { $_.localBackupInfo[0].runType -eq $rt } |
                          Sort-Object { $_.localBackupInfo[0].endTimeUsecs } -Descending | Select-Object -First 1
                if(-not $latest){ continue }
                $info = $latest.localBackupInfo[0]
                if($info.status -in @("Succeeded","SucceededWithWarning")){ continue }

                $start = ToLocal $info.startTimeUsecs
                $end   = ToLocal $info.endTimeUsecs

                if($latest.objects){
                    $vms = $latest.objects | Where-Object { $_.object.objectType -eq 'kVirtualMachine' }
                    foreach($vm in $vms){
                        $fa = $vm.localSnapshotInfo.failedAttempts
                        if(-not $fa){ continue }
                        foreach($f in $fa){
                            $msg = ($f.message -replace '[\r\n]+',' ' -replace ',',' ' -replace '"','''').Trim()
                            $global += [pscustomobject]@{
                                Cluster         = $cName
                                ProtectionGroup = $pgName
                                Environment     = $label
                                RunType         = $info.runType
                                Name            = $vm.object.name
                                StartTime       = $start
                                EndTime         = $end
                                FailedMessage   = $msg
                            }
                        }
                    }
                }
            }
        }
    }

    if($global.Count -gt 0){
        $global = $global | Group-Object {
            "$($_.Cluster)|$($_.ProtectionGroup)|$($_.RunType)|$($_.Name)|$($_.FailedMessage)|$($_.EndTime)"
        } | ForEach-Object { $_.Group | Sort-Object EndTime -Descending | Select-Object -First 1 }
        $out = $global | Sort-Object Cluster,ProtectionGroup,EndTime -Descending
        $csv = Join-Path $logDirectory ("BackupFailures_HyperV_AllClusters_{0}.csv" -f (Get-Date -Format "yyyyMMdd_HHmm"))
        SafeCsv -path $csv -rows $out | Out-Null
        return [pscustomobject]@{ Label="HyperV"; Rows=$out; Csv=$csv }
    }
    return [pscustomobject]@{ Label="HyperV"; Rows=@(); Csv=$null }
}

function Collect-Acropolis {
    $label="Acropolis"
    $filter="kAcropolis"
    $global=@()

    foreach($clus in $json_clu){
        $cName = NameOfCluster $clus
        $headers = @{ apiKey=$apiKey; accessClusterId=$clus.clusterId }

        try {
            $pgs = ((Invoke-WebRequest -Uri "$baseUrl/v2/data-protect/protection-groups" -Headers $headers -Body @{
                environments=$filter; isDeleted="False"; isPaused="False"; isActive="True"
            } -Method Get).Content | ConvertFrom-Json).protectionGroups
        } catch { continue }
        if(-not $pgs){ continue }

        foreach($pg in $pgs){
            $pgId=$pg.id;$pgName=$pg.name
            try {
                $runsJson = (Invoke-WebRequest -Uri "$baseUrl/v2/data-protect/protection-groups/$pgId/runs" -Headers $headers -Body @{
                    environments=$filter; numRuns="10"; excludeNonRestorableRuns="False"; includeObjectDetails="True"
                } -Method Get) | ConvertFrom-Json
            } catch { continue }
            if(-not $runsJson.runs){ continue }

            $runs = $runsJson.runs
            $runTypes = $runs.localBackupInfo.runType | Select-Object -Unique
            foreach($rt in $runTypes){
                $latest = $runs | Where-Object { $_.localBackupInfo[0].runType -eq $rt } |
                          Sort-Object { $_.localBackupInfo[0].endTimeUsecs } -Descending | Select-Object -First 1
                if(-not $latest){ continue }
                $info = $latest.localBackupInfo[0]
                if($info.status -in @("Succeeded","SucceededWithWarning")){ continue }

                $start = ToLocal $info.startTimeUsecs
                $end   = ToLocal $info.endTimeUsecs

                if($latest.objects){
                    $vms = $latest.objects | Where-Object { $_.object.objectType -eq 'kVirtualMachine' }
                    foreach($vm in $vms){
                        $fa = $vm.localSnapshotInfo.failedAttempts
                        if(-not $fa){ continue }
                        foreach($f in $fa){
                            $msg = ($f.message -replace '[\r\n]+',' ' -replace ',',' ' -replace '"','''').Trim()
                            $global += [pscustomobject]@{
                                Cluster         = $cName
                                ProtectionGroup = $pgName
                                Environment     = $label
                                RunType         = $info.runType
                                Name            = $vm.object.name
                                StartTime       = $start
                                EndTime         = $end
                                FailedMessage   = $msg
                            }
                        }
                    }
                }
            }
        }
    }

    if($global.Count -gt 0){
        $global = $global | Group-Object {
            "$($_.Cluster)|$($_.ProtectionGroup)|$($_.RunType)|$($_.Name)|$($_.FailedMessage)|$($_.EndTime)"
        } | ForEach-Object { $_.Group | Sort-Object EndTime -Descending | Select-Object -First 1 }
        $out = $global | Sort-Object Cluster,ProtectionGroup,EndTime -Descending
        $csv = Join-Path $logDirectory ("BackupFailures_Acropolis_AllClusters_{0}.csv" -f (Get-Date -Format "yyyyMMdd_HHmm"))
        SafeCsv -path $csv -rows $out | Out-Null
        return [pscustomobject]@{ Label="Acropolis"; Rows=$out; Csv=$csv }
    }
    return [pscustomobject]@{ Label="Acropolis"; Rows=@(); Csv=$null }
}

function Collect-RemoteAdapter {
    # keep "failed WITHOUT later success" logic
    $label="RemoteAdapter"
    $global=@()

    foreach($clus in $json_clu){
        $cName = NameOfCluster $clus
        $headers = @{ apiKey=$apiKey; accessClusterId=$clus.clusterId }

        try {
            $pgs = ((Invoke-WebRequest -Uri "$baseUrl/v2/data-protect/protection-groups" -Headers $headers -Body @{
                environments="kRemoteAdapter"; isDeleted="False"; isPaused="False"; isActive="True"
            } -Method Get).Content | ConvertFrom-Json).protectionGroups
        } catch { continue }
        if(-not $pgs){ continue }

        foreach($pg in $pgs){
            $pgId=$pg.id;$pgName=$pg.name

            # extract Host/DB from params (best-effort)
            $HostName=$null; $DBName=$null
            try {
                $HostName = $pg.remoteAdapterParams.hosts.hostname
                if ($HostName -is [System.Array]) { $HostName = ($HostName -join ',') }
                $args = $pg.remoteAdapterParams.hosts.incrementalBackupScript.params
                if ($args -is [System.Array]) { $args = ($args -join ' ') }
                if ($args -match "-o\s+(\S+)") { $DBName = $matches[1] }
            } catch {}

            try {
                $runsJson = (Invoke-WebRequest -Uri "$baseUrl/v2/data-protect/protection-groups/$pgId/runs" -Headers $headers -Body @{
                    environments="kRemoteAdapter"; numRuns="10"; excludeNonRestorableRuns="False"; includeObjectDetails="True"
                } -Method Get) | ConvertFrom-Json
            } catch { continue }
            if(-not $runsJson.runs){ continue }

            # flatten localBackupInfo to find "failed without later success"
            $flat=@()
            foreach($r in $runsJson.runs){
                foreach($i in $r.localBackupInfo){
                    $flat += [pscustomobject]@{
                        RunType         = $i.runType
                        Status          = $i.status
                        Message         = $i.messages
                        StartTimeUsecs  = $i.startTimeUsecs
                        EndTimeUsecs    = $i.endTimeUsecs
                        Cluster         = $cName
                        ProtectionGroup = $pgName
                        HostName        = $HostName
                        DBName          = $DBName
                    }
                }
            }
            if(-not $flat){ continue }

            $byType = $flat | Group-Object RunType
            foreach($g in $byType){
                $latestFailed = $g.Group | Where-Object { $_.Status -eq 'Failed' } |
                                Sort-Object EndTimeUsecs -Descending | Select-Object -First 1
                if(-not $latestFailed){ continue }

                $laterSuccess = $g.Group | Where-Object {
                    $_.Status -in @('Succeeded','SucceededWithWarning') -and $_.StartTimeUsecs -gt $latestFailed.EndTimeUsecs
                }
                if($laterSuccess){ continue }

                $start = ToLocal $latestFailed.StartTimeUsecs
                $end   = ToLocal $latestFailed.EndTimeUsecs
                $msg = $latestFailed.Message
                if ($msg -is [System.Array]) { $msg = ($msg -join ' | ') }

                $global += [pscustomobject]@{
                    Cluster         = $latestFailed.Cluster
                    ProtectionGroup = $latestFailed.ProtectionGroup
                    Environment     = $label
                    RunType         = $latestFailed.RunType
                    Name            = ($latestFailed.DBName ? $latestFailed.DBName : $latestFailed.HostName)
                    StartTime       = $start
                    EndTime         = $end
                    FailedMessage   = $msg
                }
            }
        }
    }

    if($global.Count -gt 0){
        $global = $global | Group-Object {
            "$($_.Cluster)|$($_.ProtectionGroup)|$($_.RunType)|$($_.Name)|$($_.FailedMessage)|$($_.EndTime)"
        } | ForEach-Object { $_.Group | Sort-Object EndTime -Descending | Select-Object -First 1 }
        $out = $global | Sort-Object Cluster,ProtectionGroup,EndTime -Descending
        $csv = Join-Path $logDirectory ("BackupFailures_RemoteAdapter_AllClusters_{0}.csv" -f (Get-Date -Format "yyyyMMdd_HHmm"))
        SafeCsv -path $csv -rows $out | Out-Null
        return [pscustomobject]@{ Label="RemoteAdapter"; Rows=$out; Csv=$csv }
    }
    return [pscustomobject]@{ Label="RemoteAdapter"; Rows=@(); Csv=$null }
}

# ---------- Presentation helpers ----------
function Print-Result {
    param($res, [switch]$OracleSqlMode)

    if($res.Rows.Count -gt 0){
        if($OracleSqlMode){
            # Oracle/SQL columns
            $res.Rows | Select-Object Cluster,ProtectionGroup,RunType,Hosts,DatabaseName,StartTime,EndTime,FailedMessage |
                Format-Table -AutoSize
        } else {
            # Generic columns
            $res.Rows | Select-Object Cluster,ProtectionGroup,Environment,RunType,Name,StartTime,EndTime,FailedMessage |
                Format-Table -AutoSize
        }
        if($res.Csv){ Write-Host ("`nüìÇ CSV saved: {0}" -f $res.Csv) -ForegroundColor Gray }
    } else {
        if($script:VerboseMode){
            Write-Host ("‚úÖ No failures found for {0} (All Clusters)" -f $res.Label) -ForegroundColor Green
        }
    }
}

# ---------- Menu ----------
Write-Host "=============================================" -ForegroundColor Cyan
Write-Host "   COHESITY BACKUP FAILURES ‚Äì MAIN MENU" -ForegroundColor White
Write-Host "=============================================" -ForegroundColor Cyan
Write-Host "1.  All Environments (guided; choose Verbose/Silent)"
Write-Host "2.  Oracle"
Write-Host "3.  SQL"
Write-Host "4.  Physical (File System)"
Write-Host "5.  NAS (GenericNas/Isilon)"
Write-Host "6.  Hyper-V"
Write-Host "7.  Acropolis (AHV)"
Write-Host "8.  Remote Adapter"
Write-Host "9.  Consolidated Report Only (ALL envs, SILENT)"
Write-Host "0.  Exit"
Write-Host "---------------------------------------------"
$choice = Read-Host "Enter your choice(s) (e.g. 2,3,4) or 0 to exit"

if($choice -eq "0"){ return }

if($choice -ne "9"){
    Write-Host "`nSelect Mode:" -ForegroundColor Yellow
    Write-Host "1. Verbose (detailed, color output)"
    Write-Host "2. Silent  (prints only failure tables & CSV lines)"
    $modeChoice = Read-Host "Enter mode [1 or 2]"
    $script:VerboseMode = $modeChoice -eq "1"
} else {
    $script:VerboseMode = $false  # consolidated report-only is always silent
}

# ---------- Execute ----------
$allRows = @()

function Do-Env {
    param($which)
    switch($which){
        1 {
            # Run all envs in selected mode
            $parts = @()
            foreach($fn in @('Collect-Oracle','Collect-SQL','Collect-Physical','Collect-NAS','Collect-HyperV','Collect-Acropolis','Collect-RemoteAdapter')){
                $res = & $fn
                if($res.Label -in @('Oracle','SQL')){
                    if($res.Rows.Count -gt 0){
                        Write-Host ("`nüî• Latest Failed {0} Runs (All Clusters):`n" -f $res.Label) -ForegroundColor Cyan
                        Print-Result -res $res -OracleSqlMode
                    } elseif($script:VerboseMode){
                        Write-Host ("‚úÖ No failures found for {0}" -f $res.Label) -ForegroundColor Green
                    }
                } else {
                    if($res.Rows.Count -gt 0){
                        Write-Host ("`nüî• Latest Failed {0} Runs (All Clusters):`n" -f $res.Label) -ForegroundColor Cyan
                        Print-Result -res $res
                    } elseif($script:VerboseMode){
                        Write-Host ("‚úÖ No failures found for {0}" -f $res.Label) -ForegroundColor Green
                    }
                }
                if($res.Rows.Count -gt 0){ $allRows += $res.Rows }
            }
        }
        2 { $r = Collect-Oracle;     Write-Host "`nüî• Latest Failed Oracle Runs (All Clusters):`n" -ForegroundColor Cyan; Print-Result -res $r -OracleSqlMode; if($r.Rows.Count -gt 0){$allRows += $r.Rows} }
        3 { $r = Collect-SQL;        Write-Host "`nüî• Latest Failed SQL Runs (All Clusters):`n"    -ForegroundColor Cyan; Print-Result -res $r -OracleSqlMode; if($r.Rows.Count -gt 0){$allRows += $r.Rows} }
        4 { $r = Collect-Physical;   Write-Host "`nüî• Latest Failed Physical Runs (All Clusters):`n" -ForegroundColor Cyan; Print-Result -res $r; if($r.Rows.Count -gt 0){$allRows += $r.Rows} }
        5 { $r = Collect-NAS;        Write-Host "`nüî• Latest Failed NAS Runs (All Clusters):`n"      -ForegroundColor Cyan; Print-Result -res $r; if($r.Rows.Count -gt 0){$allRows += $r.Rows} }
        6 { $r = Collect-HyperV;     Write-Host "`nüî• Latest Failed Hyper-V Runs (All Clusters):`n"  -ForegroundColor Cyan; Print-Result -res $r; if($r.Rows.Count -gt 0){$allRows += $r.Rows} }
        7 { $r = Collect-Acropolis;  Write-Host "`nüî• Latest Failed Acropolis Runs (All Clusters):`n"-ForegroundColor Cyan; Print-Result -res $r; if($r.Rows.Count -gt 0){$allRows += $r.Rows} }
        8 { $r = Collect-RemoteAdapter; Write-Host "`nüî• Latest Failed Remote Adapter Runs (All Clusters):`n" -ForegroundColor Cyan; Print-Result -res $r; if($r.Rows.Count -gt 0){$allRows += $r.Rows} }
        9 {
            # Consolidated report only, silent
            foreach($fn in @('Collect-Oracle','Collect-SQL','Collect-Physical','Collect-NAS','Collect-HyperV','Collect-Acropolis','Collect-RemoteAdapter')){
                $res = & $fn
                if($res.Rows.Count -gt 0){ $allRows += $res.Rows }
            }
        }
        default { Write-Host "‚ö†Ô∏è Invalid selection." -ForegroundColor Yellow }
    }
}

# user may pass multiple selections (except for 1 and 9 which run all)
if($choice -in @("1","9")){
    Do-Env $choice
} else {
    $selected = $choice.Split(',') | ForEach-Object { $_.Trim() } | Where-Object { $_ -match '^\d+$' }
    foreach($s in $selected){ Do-Env ([int]$s) }
}

# ---------- Combined output ----------
if($allRows.Count -gt 0){
    Write-Host "`nüî• Combined Failures ‚Äì Selected Scope" -ForegroundColor Magenta
    # Use generic columns; Oracle/SQL rows still carry Hosts/DatabaseName in properties but we display a universal view here
    $combined = $allRows | Sort-Object Cluster,ProtectionGroup,Environment,EndTime -Descending
    $combined | Select-Object Cluster,ProtectionGroup,Environment,RunType,
                               @{n='Entity';e={ if($_.PSObject.Properties['DatabaseName']){ $_.DatabaseName } else { $_.Name } }},
                               @{n='Host';  e={ if($_.PSObject.Properties['Hosts']){ $_.Hosts } else { $null } }},
                               StartTime,EndTime,FailedMessage | Format-Table -AutoSize

    $combinedPath = Join-Path $logDirectory ("BackupFailures_SelectedScope_{0}.csv" -f (Get-Date -Format "yyyyMMdd_HHmm"))
    SafeCsv -path $combinedPath -rows $combined | Out-Null
    Write-Host ("`nüìÇ Combined CSV saved: {0}" -f $combinedPath) -ForegroundColor Gray
} else {
    # in silent mode we do not print "no failures" for each env; but if overall none, say it once.
    Write-Host "`n‚úÖ No failures found in the selected scope." -ForegroundColor Green
}
