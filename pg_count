$pgSummary = @()

foreach ($pg in $allProtectionGroups) {
    $pgId        = $pg.ID
    $pgName      = $pg.Name
    $clusterName = $pg.Cluster

    # All runs
    $allUrl   = "https://helios.cohesity.com/v2/data-protect/protection-groups/$pgId/runs"
    $allResp  = Invoke-RestMethod -Method Get -Uri $allUrl -Headers $headers
    $allRuns  = if ($allResp -and $allResp.runs) { $allResp.runs } else { @() }

    # Restorable runs (with snapshots)
    $snapBody = @{ excludeNonRestorableRuns = $true } | ConvertTo-Json
    $snapUrl  = "https://helios.cohesity.com/v2/data-protect/protection-groups/$pgId/runs"
    $snapResp = Invoke-RestMethod -Method Post -Uri $snapUrl -Headers $headers -Body $snapBody -ContentType "application/json"
    $snapRuns = if ($snapResp -and $snapResp.runs) { $snapResp.runs } else { @() }

    $pgSummary += [pscustomobject]@{
        Cluster         = $clusterName
        ProtectionGroup = $pgName
        TotalRuns       = $allRuns.Count
        RestorableRuns  = $snapRuns.Count
        HasSnapshots    = if ($snapRuns.Count -gt 0) { "Yes" } else { "No" }
    }
}

$pgSummary | Sort-Object Cluster, ProtectionGroup | Format-Table -AutoSize
