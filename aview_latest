$ErrorActionPreference = 'Stop'

# ----------------------------------------------
# ðŸ”¢ Lookback window (days) for growth
# ----------------------------------------------
$Days = 30   # last 30 days

# -------------------------------------------------------------
# ðŸ“ Log directory + hygiene
# -------------------------------------------------------------
$logDirectory = "X:\PowerShell\Data\Cohesity\"
if (-not (Test-Path -Path $logDirectory -PathType Container)) {
    New-Item -Path $logDirectory -ItemType Directory | Out-Null
}

# Hygiene 1: keep at most 50 newest files
try {
    $files = Get-ChildItem -Path $logDirectory -File -ErrorAction Stop
    if ($files.Count -gt 50) {
        $toDelete = $files | Sort-Object CreationTime | Select-Object -First ($files.Count - 50)
        $count    = ($toDelete | Measure-Object).Count
        if ($count -gt 0) {
            $toDelete | Remove-Item -Force -ErrorAction SilentlyContinue
            Write-Host "ðŸ§¹ Removed $count old files to keep last 50."
        }
    }
} catch {}

# Hygiene 2: delete anything older than 30 days
try {
    $threshold = (Get-Date).AddDays(-30)
    $older = Get-ChildItem -Path $logDirectory -File -ErrorAction SilentlyContinue |
             Where-Object { $_.LastWriteTime -lt $threshold }
    $oldCount = ($older | Measure-Object).Count
    if ($oldCount -gt 0) {
        $older | Remove-Item -Force -ErrorAction SilentlyContinue
        Write-Host "ðŸ§½ Deleted $oldCount files older than 30 days."
    }
} catch {}

# -------------------------------------------------------------
# 0ï¸âƒ£ API key from your path
# -------------------------------------------------------------
$apikeypath = "X:\PowerShell\Cohesity_API_Scripts\DO_NOT_Delete\apikey.txt"
if (-not (Test-Path $apikeypath)) {
    throw "API key file not found at $apikeypath"
}

$apiKey        = (Get-Content -Path $apikeypath -Raw).Trim()
$commonHeaders = @{ "apiKey" = $apiKey }

# Base URLs
$baseMcm  = "https://helios.cohesity.com/v2/mcm"
$baseIris = "https://helios.cohesity.com/irisservices/api/v1/public"

# -------------------------------------------------------------
# 1ï¸âƒ£ Get Clusters (ClusterName + ClusterId) via GET
# -------------------------------------------------------------
$url      = "$baseMcm/cluster-mgmt/info"
$response = Invoke-WebRequest -Method Get -Uri $url -Headers $commonHeaders
$json     = $response.Content | ConvertFrom-Json
$json_clu = $json.cohesityClusters

if (-not $json_clu -or $json_clu.Count -eq 0) {
    throw "No clusters returned from Helios."
}

# -------------------------------------------------------------
# 2ï¸âƒ£ Sort alphabetically and build index
# -------------------------------------------------------------
$sorted = $json_clu | Sort-Object -Property clusterName

$clusters = for ($i = 0; $i -lt $sorted.Count; $i++) {
    [pscustomobject]@{
        Index       = $i + 1
        ClusterName = $sorted[$i].clusterName
        ClusterId   = $sorted[$i].clusterId
    }
}

Write-Host ""
Write-Host "Available Helios Clusters (sorted by name):" -ForegroundColor Cyan
$clusters | Format-Table -AutoSize

Write-Host ""
Write-Host "[0] All clusters" -ForegroundColor Yellow
Write-Host "[X] Exit without selecting" -ForegroundColor Yellow
Write-Host ""

# -------------------------------------------------------------
# 3ï¸âƒ£ Let user select ALL, ONE, or EXIT
# -------------------------------------------------------------
$selection           = $null
$AllClustersSelected = $false

while ($true) {

    $inputVal = Read-Host "Enter 0 for ALL, 1-$($clusters.Count) for single, or X to exit"

    if ($inputVal -match '^(x|X|q|Q)$') {
        Write-Host "Exit selected. No clusters chosen." -ForegroundColor Cyan
        return
    }

    [int]$num = 0
    if (-not [int]::TryParse($inputVal, [ref]$num)) {
        Write-Host "Please enter a valid number or X to exit." -ForegroundColor Red
        continue
    }

    if ($num -lt 0 -or $num -gt $clusters.Count) {
        Write-Host "Please enter 0, 1-$($clusters.Count), or X to exit." -ForegroundColor Red
        continue
    }

    $selection = $num
    break
}

if ($selection -eq 0) {
    $SelectedClusters    = $clusters
    $SelectedClusterIds  = $clusters.ClusterId
    $AllClustersSelected = $true

    Write-Host ""
    Write-Host "You selected: ALL clusters" -ForegroundColor Green
    $SelectedClusters | Format-Table -AutoSize
}
else {
    $selectedCluster     = $clusters | Where-Object { $_.Index -eq $selection }
    $SelectedClusters    = @($selectedCluster)
    $SelectedClusterIds  = @($selectedCluster.ClusterId)
    $AllClustersSelected = $false

    Write-Host ""
    Write-Host "You selected cluster:" -ForegroundColor Green
    Write-Host "  Name: $($selectedCluster.ClusterName)"
    Write-Host "  Id:   $($selectedCluster.ClusterId)"
    Write-Host ""
}

# -------------------------------------------------------------
# 4ï¸âƒ£ Helpers: time + size + reduction + K-format
# -------------------------------------------------------------
function Get-TimeMsecs {
    param(
        [Parameter(Mandatory = $true)][datetime]$Date
    )
    $epoch = [datetime]::SpecifyKind([datetime]'1970-01-01T00:00:00Z', [System.DateTimeKind]::Utc)
    return [int64]($Date.ToUniversalTime() - $epoch).TotalMilliseconds
}

# Decimal PB/TB/GB/MB/KB/B with 1 decimal
function Format-Size {
    param(
        [Parameter(Mandatory = $true)]
        [long]$Size
    )

    $abs = [math]::Abs($Size)

    if ($abs -ge 1e15) {          # 1 PB
        $value = $Size / 1e15
        $unit  = 'PB'
    }
    elseif ($abs -ge 1e12) {      # 1 TB
        $value = $Size / 1e12
        $unit  = 'TB'
    }
    elseif ($abs -ge 1e9) {       # 1 GB
        $value = $Size / 1e9
        $unit  = 'GB'
    }
    elseif ($abs -ge 1e6) {       # 1 MB
        $value = $Size / 1e6
        $unit  = 'MB'
    }
    elseif ($abs -ge 1e3) {       # 1 KB
        $value = $Size / 1e3
        $unit  = 'KB'
    }
    else {
        $value = $Size
        $unit  = 'B'
    }

    "{0:N1} {1}" -f $value, $unit
}

# K-format without commas inside the number (e.g., 1189.5K)
function Format-K {
    param([long]$Value)

    if ($null -eq $Value) { return $null }
    if ($Value -eq 0)     { return "0" }

    $abs = [math]::Abs([double]$Value)
    if ($abs -lt 1000) { return ("{0:0}" -f $Value) }

    return ("{0:0.0}K" -f ($Value / 1e3))
}

function Compute-Reduction {
    param(
        [long]$LogicalBytes,
        [long]$PhysicalBytes
    )

    if ($PhysicalBytes -le 0 -or $LogicalBytes -le 0) { return "-" }

    $ratio = [double]$LogicalBytes / [double]$PhysicalBytes
    "{0:N1}x" -f $ratio
}

# -------------------------------------------------------------
# 5ï¸âƒ£ Time window for growth (last $Days days)
# -------------------------------------------------------------
$endDate   = Get-Date
$startDate = $endDate.AddDays(-$Days)

$startDateString = $startDate.ToString("yyyy-MM-dd")
$endDateString   = $endDate.ToString("yyyy-MM-dd")

$startDateMsecs = Get-TimeMsecs -Date $startDate
$endDateMsecs   = Get-TimeMsecs -Date $endDate

# -------------------------------------------------------------
# 6ï¸âƒ£ Accumulators & CSV paths
# -------------------------------------------------------------
$combinedAll            = @()

$globalStartBytes       = 0L
$globalEndBytes         = 0L
$globalLogicalNowBytes  = 0L
$globalPhysicalNowBytes = 0L
$globalResiliencyBytes  = 0L
$globalConsumedBytes    = 0L
$globalFilesRaw         = 0L
$globalDirsRaw          = 0L

$clusterCsvPath     = $null  # single-cluster CSV
$allClustersCsvPath = $null  # all-clusters CSV

# vars to hold global TOTAL formatted values for CSV
$totStartFmt       = $null
$totEndFmt         = $null
$totGrowthFmt      = $null
$totPctFmt         = $null
$totLogicalNowFmt  = $null
$totPhysicalNowFmt = $null
$totResiliencyFmt  = $null
$totConsumedFmt    = $null
$totFilesFmt       = $null
$totDirsFmt        = $null
$globalTotalRow    = $null

# -------------------------------------------------------------
# 7ï¸âƒ£ For each selected cluster: growth + current stats (GET only)
# -------------------------------------------------------------
foreach ($cid in $SelectedClusterIds) {

    $cluster_name = ($SelectedClusters | Where-Object { $_.ClusterId -eq $cid }).ClusterName

    $headers = @{
        "apiKey"          = $apiKey
        "accessClusterId" = $cid
    }

    # 7.1 Get basic views (for viewId + name)
    try {
        $viewsUrl  = "$baseIris/views"
        $viewsResp = Invoke-WebRequest -Method Get -Uri $viewsUrl -Headers $headers
        $viewsJson = $viewsResp.Content | ConvertFrom-Json
        $views     = $viewsJson.views
    }
    catch {
        Write-Host "Failed to get views for cluster '$cluster_name' (Id: $cid): $_" -ForegroundColor Red
        continue
    }

    if (-not $views) {
        Write-Host "No views returned for cluster '$cluster_name'." -ForegroundColor Yellow
        continue
    }

    $views = $views | Sort-Object -Property name

    # -------------------------------------------
    # 7.A Build growth data from timeSeriesStats
    # -------------------------------------------
    $growthResults = @()

    foreach ($view in $views) {

        $viewName = $view.name
        $viewId   = $view.viewId

        $statsUrl =
            "$baseIris/statistics/timeSeriesStats" +
            "?endTimeMsecs=$endDateMsecs" +
            "&startTimeMsecs=$startDateMsecs" +
            "&entityId=$viewId" +
            "&metricName=kSystemUsageBytes" +
            "&metricUnitType=0" +
            "&range=week" +
            "&rollupFunction=latest" +
            "&rollupIntervalSecs=14400" +
            "&schemaName=kBridgeViewLogicalStats"

        try {
            $statsResp = Invoke-WebRequest -Method Get -Uri $statsUrl -Headers $headers
            $stats     = $statsResp.Content | ConvertFrom-Json
        }
        catch {
            Write-Host "  âš  Failed to get growth stats for view '$viewName' on '$cluster_name': $_" -ForegroundColor Red
            continue
        }

        if (-not $stats -or -not $stats.dataPointVec -or $stats.dataPointVec.Count -eq 0) {
            $growthResults += [pscustomobject]@{
                ClusterName   = $cluster_name
                ViewName      = $viewName
                StartBytes    = 0L
                EndBytes      = 0L
                LogicalStart  = "0 B"
                LogicalEnd    = "0 B"
                GrowthSize    = "0 B"
                PercentGrowth = "N/A"
            }
            continue
        }

        $startBytes  = [int64]$stats.dataPointVec[0].data.int64Value
        $endBytes    = [int64]$stats.dataPointVec[-1].data.int64Value
        $growthBytes = $endBytes - $startBytes

        $startFmt    = Format-Size -Size $startBytes
        $endFmt      = Format-Size -Size $endBytes
        $growthFmt   = Format-Size -Size $growthBytes

        if ($startBytes -gt 0) {
            $pct    = [math]::Round(($growthBytes * 100.0) / $startBytes, 1)
            $pctFmt = "{0:N1} %" -f $pct
        }
        else {
            $pctFmt = "N/A"
        }

        $growthResults += [pscustomobject]@{
            ClusterName   = $cluster_name
            ViewName      = $viewName
            StartBytes    = $startBytes
            EndBytes      = $endBytes
            LogicalStart  = $startFmt
            LogicalEnd    = $endFmt
            GrowthSize    = $growthFmt
            PercentGrowth = $pctFmt
        }
    }

    # -------------------------------------------
    # 7.B Get current capacity stats (includeStats=true)
    # -------------------------------------------
    $viewsStatsUrl  = "$baseIris/views?includeStats=true"
    $snapshotByName = @{}

    try {
        $vsResp  = Invoke-WebRequest -Method Get -Uri $viewsStatsUrl -Headers $headers
        $vsJson  = $vsResp.Content | ConvertFrom-Json
        if ($vsJson.views) {
            $viewsWithStats = $vsJson.views
        }
        else {
            $viewsWithStats = $vsJson
        }
    }
    catch {
        Write-Host "  âš  Failed to get includeStats for cluster '$cluster_name': $_" -ForegroundColor Red
        $viewsWithStats = @()
    }

    foreach ($view in $viewsWithStats) {

        $name = $view.name
        if (-not $name) { continue }

        $stats = $view.stats.dataUsageStats
        if (-not $stats) { continue }

        if ($stats -is [System.Collections.IEnumerable] -and -not ($stats -is [string])) {
            $stats = $stats[0]
        }

        $logicalNowBytes   = [int64]$stats.totalLogicalUsageBytes
        $physicalNowBytes  = [int64]$stats.localTotalPhysicalUsageBytes
        $overheadBytes     = [int64]$stats.localTierResiliencyImpactBytes
        $consumedBytes     = [int64]$stats.storageConsumedBytes
        $numFilesRaw       = [int64]$stats.numFiles
        $numDirsRaw        = [int64]$stats.numDirectories

        $reductionNow      = Compute-Reduction -LogicalBytes $logicalNowBytes -PhysicalBytes $physicalNowBytes

        $snapshotByName[$name] = [pscustomobject]@{
            LogicalNowBytes   = $logicalNowBytes
            PhysicalNowBytes  = $physicalNowBytes
            ResiliencyBytes   = $overheadBytes
            ConsumedBytes     = $consumedBytes
            NumFilesRaw       = $numFilesRaw
            NumDirsRaw        = $numDirsRaw

            LogicalNow        = Format-Size $logicalNowBytes
            PhysicalNow       = Format-Size $physicalNowBytes
            ReductionNow      = $reductionNow
            ResiliencyImpact  = Format-Size $overheadBytes
            ConsumedNow       = Format-Size $consumedBytes
            NumFiles          = Format-K  $numFilesRaw
            NumDirs           = Format-K  $numDirsRaw
        }
    }

    if (-not $growthResults) {
        Write-Host "No view growth data collected for cluster '$cluster_name'." -ForegroundColor Yellow
        continue
    }

    # ---------------------------------------------------------
    # 7.C Combine: growth (30d) + current snapshot (Now)
    # ---------------------------------------------------------
    $clusterCombined = @()

    foreach ($g in ($growthResults | Sort-Object -Property ViewName)) {

        $snap = $null
        if ($snapshotByName.ContainsKey($g.ViewName)) {
            $snap = $snapshotByName[$g.ViewName]
        }

        if ($snap) {
            $logicalNowDisplay = $snap.LogicalNow
            $physicalNow       = $snap.PhysicalNow
            $reductionNow      = $snap.ReductionNow
            $impactNow         = $snap.ResiliencyImpact
            $consumedNow       = $snap.ConsumedNow
            $numFiles          = $snap.NumFiles
            $numDirs           = $snap.NumDirs

            $logicalNowBytesForTotal  = $snap.LogicalNowBytes
            $physicalNowBytesForTotal = $snap.PhysicalNowBytes
            $overheadBytesForTotal    = $snap.ResiliencyBytes
            $consumedBytesForTotal    = $snap.ConsumedBytes
            $numFilesRawForTotal      = $snap.NumFilesRaw
            $numDirsRawForTotal       = $snap.NumDirsRaw
        }
        else {
            $logicalNowDisplay        = $g.LogicalEnd
            $physicalNow              = "0 B"
            $reductionNow             = "-"
            $impactNow                = "0 B"
            $consumedNow              = "0 B"
            $numFiles                 = ""
            $numDirs                  = ""

            $logicalNowBytesForTotal  = $g.EndBytes
            $physicalNowBytesForTotal = 0L
            $overheadBytesForTotal    = 0L
            $consumedBytesForTotal    = 0L
            $numFilesRawForTotal      = 0L
            $numDirsRawForTotal       = 0L
        }

        $row = [pscustomobject]@{
            ClusterName        = $g.ClusterName
            ViewName           = $g.ViewName

            StartBytes         = $g.StartBytes
            EndBytes           = $g.EndBytes
            LogicalNowBytes    = $logicalNowBytesForTotal
            PhysicalNowBytes   = $physicalNowBytesForTotal
            ResiliencyBytes    = $overheadBytesForTotal
            ConsumedBytes      = $consumedBytesForTotal
            NumFilesRaw        = $numFilesRawForTotal
            NumDirsRaw         = $numDirsRawForTotal

            LogicalStart       = $g.LogicalStart
            LogicalEnd         = $g.LogicalEnd
            GrowthSize         = $g.GrowthSize
            PercentGrowth      = $g.PercentGrowth

            LogicalNow         = $logicalNowDisplay
            PhysicalNow        = $physicalNow
            ReductionNow       = $reductionNow
            ResiliencyImpact   = $impactNow
            ConsumedNow        = $consumedNow
            NumFiles           = $numFiles
            NumDirs            = $numDirs
        }

        $clusterCombined += $row
        $combinedAll     += $row

        # Global totals across all selected clusters
        $globalStartBytes       += $row.StartBytes
        $globalEndBytes         += $row.EndBytes
        $globalLogicalNowBytes  += $row.LogicalNowBytes
        $globalPhysicalNowBytes += $row.PhysicalNowBytes
        $globalResiliencyBytes  += $row.ResiliencyBytes
        $globalConsumedBytes    += $row.ConsumedBytes
        $globalFilesRaw         += $row.NumFilesRaw
        $globalDirsRaw          += $row.NumDirsRaw
    }

    # ---------------------------------------------------------
    # 7.D Single-cluster TOTAL row (only if ONE selected)
    #     (no CSV export here; that comes at the very end)
    # ---------------------------------------------------------
    if (-not $AllClustersSelected) {

        $totStartBytes       = [int64](($clusterCombined.StartBytes       | Measure-Object -Sum).Sum)
        $totEndBytes         = [int64](($clusterCombined.EndBytes         | Measure-Object -Sum).Sum)
        $totLogicalNowBytes  = [int64](($clusterCombined.LogicalNowBytes  | Measure-Object -Sum).Sum)
        $totPhysicalNowBytes = [int64](($clusterCombined.PhysicalNowBytes | Measure-Object -Sum).Sum)
        $totResiliencyBytes  = [int64](($clusterCombined.ResiliencyBytes  | Measure-Object -Sum).Sum)
        $totConsumedBytes    = [int64](($clusterCombined.ConsumedBytes    | Measure-Object -Sum).Sum)
        $totFilesRaw         = [int64](($clusterCombined.NumFilesRaw      | Measure-Object -Sum).Sum)
        $totDirsRaw          = [int64](($clusterCombined.NumDirsRaw       | Measure-Object -Sum).Sum)

        $totGrowthBytes      = $totEndBytes - $totStartBytes
        $totStartFmt_local   = Format-Size $totStartBytes
        $totEndFmt_local     = Format-Size $totEndBytes
        $totGrowthFmt_local  = Format-Size $totGrowthBytes

        if ($totStartBytes -gt 0) {
            $totPct_local = [math]::Round(($totGrowthBytes * 100.0) / $totStartBytes, 1)
            $totPctFmt_local = "{0:N1} %" -f $totPct_local
        }
        else {
            $totPctFmt_local = "N/A"
        }

        $totalReduction      = Compute-Reduction -LogicalBytes $totLogicalNowBytes -PhysicalBytes $totPhysicalNowBytes
        $totLogicalNowFmt_local  = Format-Size $totLogicalNowBytes
        $totPhysicalNowFmt_local = Format-Size $totPhysicalNowBytes
        $totResiliencyFmt_local  = Format-Size $totResiliencyBytes
        $totConsumedFmt_local    = Format-Size $totConsumedBytes
        $totFilesFmt_local       = Format-K    $totFilesRaw
        $totDirsFmt_local        = Format-K    $totDirsRaw

        $totalRow = [pscustomobject]@{
            ClusterName        = $cluster_name
            ViewName           = 'TOTAL'

            LogicalStart       = $totStartFmt_local
            LogicalEnd         = $totEndFmt_local
            GrowthSize         = $totGrowthFmt_local
            PercentGrowth      = $totPctFmt_local

            LogicalNow         = $totLogicalNowFmt_local
            PhysicalNow        = $totPhysicalNowFmt_local
            ReductionNow       = $totalReduction
            ResiliencyImpact   = $totResiliencyFmt_local
            ConsumedNow        = $totConsumedFmt_local
            NumFiles           = $totFilesFmt_local
            NumDirs            = $totDirsFmt_local
        }

        $clusterCombined = $clusterCombined | Sort-Object ViewName
        $clusterCombined += $totalRow

        # For single cluster, combinedAll should be exactly that table
        $combinedAll = $clusterCombined

        # remember path for later CSV export
        $safeClusterName = ($cluster_name -replace ':', '_')
        $clusterCsvPath  = Join-Path -Path $logDirectory -ChildPath (
            "ViewGrowthAndCapacity_${safeClusterName}_$($startDateString)_$($endDateString).csv"
        )
    }
    else {
        # ALL clusters: no per-cluster totals or CSVs
        continue
    }
}

if (-not $combinedAll -or $combinedAll.Count -eq 0) {
    Write-Host ""
    Write-Host "No data collected for selected clusters." -ForegroundColor Yellow
    return
}

# -------------------------------------------------------------
# 8ï¸âƒ£ Global TOTAL (only when ALL clusters selected)
# -------------------------------------------------------------
if ($AllClustersSelected) {

    $totStartBytes       = $globalStartBytes
    $totEndBytes         = $globalEndBytes
    $totLogicalNowBytes  = $globalLogicalNowBytes
    $totPhysicalNowBytes = $globalPhysicalNowBytes
    $totResiliencyBytes  = $globalResiliencyBytes
    $totConsumedBytes    = $globalConsumedBytes
    $totFilesRaw         = $globalFilesRaw
    $totDirsRaw          = $globalDirsRaw

    $totGrowthBytes      = $totEndBytes - $totStartBytes
    $totStartFmt         = Format-Size $totStartBytes
    $totEndFmt           = Format-Size $totEndBytes
    $totGrowthFmt        = Format-Size $totGrowthBytes

    if ($totStartBytes -gt 0) {
        $totPct        = [math]::Round(($totGrowthBytes * 100.0) / $totStartBytes, 1)
        $totPctFmt     = "{0:N1} %" -f $totPct
    }
    else {
        $totPctFmt     = "N/A"
    }

    $totalReduction      = Compute-Reduction -LogicalBytes $totLogicalNowBytes -PhysicalBytes $totPhysicalNowBytes
    $totLogicalNowFmt    = Format-Size $totLogicalNowBytes
    $totPhysicalNowFmt   = Format-Size $totPhysicalNowBytes
    $totResiliencyFmt    = Format-Size $totResiliencyBytes
    $totConsumedFmt      = Format-Size $totConsumedBytes
    $totFilesFmt         = Format-K    $totFilesRaw
    $totDirsFmt          = Format-K    $totDirsRaw

    $globalTotalRow = [pscustomobject]@{
        Scope             = 'ALL_SELECTED_CLUSTERS'
        LogicalStart      = $totStartFmt
        LogicalEnd        = $totEndFmt
        GrowthSize        = $totGrowthFmt
        PercentGrowth     = $totPctFmt
        LogicalNow        = $totLogicalNowFmt
        PhysicalNow       = $totPhysicalNowFmt
        ReductionNow      = $totalReduction
        ResiliencyImpact  = $totResiliencyFmt
        ConsumedNow       = $totConsumedFmt
        NumFiles          = $totFilesFmt
        NumDirs           = $totDirsFmt
    }

    Write-Host ""
    Write-Host "=== TOTAL (All Selected Clusters â€“ Current & ${Days}d Growth) ===" -ForegroundColor Cyan
    Write-Host ""

    $globalTotalRow |
        Format-Table `
            Scope,
            LogicalStart,
            LogicalEnd,
            GrowthSize,
            PercentGrowth,
            LogicalNow,
            PhysicalNow,
            ReductionNow,
            ResiliencyImpact,
            ConsumedNow,
            NumFiles,
            NumDirs -AutoSize
}

# -------------------------------------------------------------
# 9ï¸âƒ£ Final table output (single cluster OR all clusters)
# -------------------------------------------------------------
Write-Host ""
Write-Host "ðŸ“… ${Days}-day window (used only for growth columns below): $startDateString -> $endDateString" -ForegroundColor Yellow
Write-Host ""

$combinedAll |
    Sort-Object ClusterName, ViewName |
    Format-Table `
        ClusterName,
        ViewName,
        @{ Label = "StartLogical(${Days}dAgo)"; Expression = { $_.LogicalStart } },
        @{ Label = "EndLogical(${Days}dEnd)";   Expression = { $_.LogicalEnd } },
        @{ Label = "Growth(${Days}d)";          Expression = { $_.GrowthSize } },
        @{ Label = "Growth%(${Days}d)";         Expression = { $_.PercentGrowth } },
        @{ Label = "LogicalNow";                Expression = { $_.LogicalNow } },
        @{ Label = "PhysicalNow";               Expression = { $_.PhysicalNow } },
        @{ Label = "ReductionNow";              Expression = { $_.ReductionNow } },
        @{ Label = "ResiliencyImpact";          Expression = { $_.ResiliencyImpact } },
        @{ Label = "ConsumedNow";               Expression = { $_.ConsumedNow } },
        @{ Label = "NumFiles";                  Expression = { $_.NumFiles } },
        @{ Label = "NumDirs";                   Expression = { $_.NumDirs } } `
    -AutoSize

# -------------------------------------------------------------
# ðŸ”Ÿ CSV export + messages (AFTER all tables)
# -------------------------------------------------------------
if (-not $AllClustersSelected) {
    # Single-cluster: one CSV for that cluster
    if ($clusterCsvPath) {
        $combinedAll |
            Select-Object ClusterName,
                          ViewName,
                          @{Name="StartLogical(${Days}dAgo)"; Expression={ $_.LogicalStart }},
                          @{Name="EndLogical(${Days}dEnd)";   Expression={ $_.LogicalEnd }},
                          @{Name="Growth(${Days}d)";          Expression={ $_.GrowthSize }},
                          @{Name="Growth%(${Days}d)";         Expression={ $_.PercentGrowth }},
                          LogicalNow,
                          PhysicalNow,
                          ReductionNow,
                          ResiliencyImpact,
                          ConsumedNow,
                          NumFiles,
                          NumDirs |
            Export-Csv -Path $clusterCsvPath -NoTypeInformation

        $clusterNameMsg = $SelectedClusters[0].ClusterName
        Write-Host ""
        Write-Host "ðŸ“„ Cluster CSV written for '$clusterNameMsg': $clusterCsvPath" -ForegroundColor Green
    }
}
else {
    # ALL clusters: only one consolidated CSV
    $allOutName        = "ViewGrowthAndCapacity_ALLCLUSTERS_${startDateString}_${endDateString}.csv"
    $allClustersCsvPath = Join-Path -Path $logDirectory -ChildPath $allOutName

    $csvRows = @()
    $csvRows += $combinedAll | Sort-Object ClusterName, ViewName

    if ($globalTotalRow) {
        $csvRows += [pscustomobject]@{
            ClusterName        = 'ALL_SELECTED_CLUSTERS'
            ViewName           = 'TOTAL'
            LogicalStart       = $globalTotalRow.LogicalStart
            LogicalEnd         = $globalTotalRow.LogicalEnd
            GrowthSize         = $globalTotalRow.GrowthSize
            PercentGrowth      = $globalTotalRow.PercentGrowth
            LogicalNow         = $globalTotalRow.LogicalNow
            PhysicalNow        = $globalTotalRow.PhysicalNow
            ReductionNow       = $globalTotalRow.ReductionNow
            ResiliencyImpact   = $globalTotalRow.ResiliencyImpact
            ConsumedNow        = $globalTotalRow.ConsumedNow
            NumFiles           = $globalTotalRow.NumFiles
            NumDirs            = $globalTotalRow.NumDirs
        }
    }

    $csvRows |
        Select-Object ClusterName,
                      ViewName,
                      @{Name="StartLogical(${Days}dAgo)"; Expression={ $_.LogicalStart }},
                      @{Name="EndLogical(${Days}dEnd)";   Expression={ $_.LogicalEnd }},
                      @{Name="Growth(${Days}d)";          Expression={ $_.GrowthSize }},
                      @{Name="Growth%(${Days}d)";         Expression={ $_.PercentGrowth }},
                      LogicalNow,
                      PhysicalNow,
                      ReductionNow,
                      ResiliencyImpact,
                      ConsumedNow,
                      NumFiles,
                      NumDirs |
        Export-Csv -Path $allClustersCsvPath -NoTypeInformation

    Write-Host ""
    Write-Host "ðŸ“„ Consolidated CSV written: $allClustersCsvPath" -ForegroundColor Green
}
