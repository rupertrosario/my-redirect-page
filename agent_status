# -------------------------------------------------------------
# 0️⃣ API key from your path
# -------------------------------------------------------------
$apikeypath = "X:\PowerShell\Cohesity_API_Scripts\DO_NOT_Delete\apikey.txt"
if (-not (Test-Path $apikeypath)) { 
    throw "API key file not found at $apikeypath" 
}

$apiKey        = (Get-Content -Path $apikeypath -Raw).Trim()
$commonHeaders = @{ "apiKey" = $apiKey }

# -------------------------------------------------------------
# 1️⃣ Get Clusters (ClusterName + ClusterId)
# -------------------------------------------------------------
$url      = "https://helios.cohesity.com/v2/mcm/cluster-mgmt/info"
$response = Invoke-WebRequest -Method Get -Uri $url -Headers $commonHeaders
$json     = $response.Content | ConvertFrom-Json
$json_clu = $json.cohesityClusters

if (-not $json_clu -or $json_clu.Count -eq 0) { 
    throw "No clusters returned from Helios." 
}

# -------------------------------------------------------------
# 2️⃣ Let user select ONE cluster to test
# -------------------------------------------------------------
# Create a simple list with index, name, id
$clusters = $json_clu | Select-Object `
    @{Name='Index';      Expression = { [array]::IndexOf($json_clu, $_) + 1 } },
    @{Name='ClusterName';Expression = { $_.clusterName } },
    @{Name='ClusterId';  Expression = { $_.clusterId } }

Write-Host ""
Write-Host "Available Helios Clusters:" -ForegroundColor Cyan
$clusters | Format-Table -AutoSize

# Ask the user which one to use
[int]$selection = 0
while ($selection -lt 1 -or $selection -gt $clusters.Count) {
    $selection = Read-Host "Enter the Index of the cluster you want to test (1-$($clusters.Count))"
}

$selectedCluster = $clusters | Where-Object { $_.Index -eq $selection }

$SelectedClusterName = $selectedCluster.ClusterName
$SelectedClusterId   = $selectedCluster.ClusterId

Write-Host ""
Write-Host "You selected cluster:" -ForegroundColor Green
Write-Host "  Name: $SelectedClusterName"
Write-Host "  Id:   $SelectedClusterId"
Write-Host ""

# -------------------------------------------------------------
# 3️⃣ Example: how to use the selected ClusterId in further API calls
# -------------------------------------------------------------
# For example, if the next API you test requires clusterId as a query parameter:
# $jobsUrl = "https://helios.cohesity.com/v2/data-protect/protection-groups?clusterId=$SelectedClusterId"
# $jobsResponse = Invoke-WebRequest -Method Get -Uri $jobsUrl -Headers $commonHeaders
# $jobs        = $jobsResponse.Content | ConvertFrom-Json
# $jobs | Select-Object name, id, @$SelectedClusterName
