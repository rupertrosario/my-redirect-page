$ErrorActionPreference = 'Stop'

# -------------------------------------------------------------
# 0️⃣ API key from your path
# -------------------------------------------------------------
$apikeypath = "X:\PowerShell\Cohesity_API_Scripts\DO_NOT_Delete\apikey.txt"
if (-not (Test-Path $apikeypath)) {
    throw "API key file not found at $apikeypath"
}

$apiKey        = (Get-Content -Path $apikeypath -Raw).Trim()
$commonHeaders = @{ "apiKey" = $apiKey }

# -------------------------------------------------------------
# 1️⃣ Get Clusters (ClusterName + ClusterId)
# -------------------------------------------------------------
$url      = "https://helios.cohesity.com/v2/mcm/cluster-mgmt/info"
$response = Invoke-WebRequest -Method Get -Uri $url -Headers $commonHeaders
$json     = $response.Content | ConvertFrom-Json
$json_clu = $json.cohesityClusters

if (-not $json_clu -or $json_clu.Count -eq 0) {
    throw "No clusters returned from Helios."
}

# -------------------------------------------------------------
# 2️⃣ Sort alphabetically and build index
# -------------------------------------------------------------
$sorted = $json_clu | Sort-Object -Property clusterName

$clusters = for ($i = 0; $i -lt $sorted.Count; $i++) {
    [pscustomobject]@{
        Index       = $i + 1
        ClusterName = $sorted[$i].clusterName
        ClusterId   = $sorted[$i].clusterId
    }
}

Write-Host ""
Write-Host "Available Helios Clusters (sorted by name):" -ForegroundColor Cyan
$clusters | Format-Table -AutoSize

Write-Host ""
Write-Host "[0] All clusters" -ForegroundColor Yellow
Write-Host "[X] Exit without selecting" -ForegroundColor Yellow
Write-Host ""

# -------------------------------------------------------------
# 3️⃣ Let user select ALL, ONE, or EXIT
# -------------------------------------------------------------
$selection = $null

while ($true) {

    $inputVal = Read-Host "Enter 0 for ALL, 1-$($clusters.Count) for single, or X to exit"

    # Exit option
    if ($inputVal -match '^(x|X|q|Q)$') {
        Write-Host "Exit selected. No clusters chosen." -ForegroundColor Cyan
        return
    }

    # Numeric?
    [int]$num = 0
    if (-not [int]::TryParse($inputVal, [ref]$num)) {
        Write-Host "Please enter a valid number or X to exit." -ForegroundColor Red
        continue
    }

    if ($num -lt 0 -or $num -gt $clusters.Count) {
        Write-Host "Please enter 0, 1-$($clusters.Count), or X to exit." -ForegroundColor Red
        continue
    }

    $selection = $num
    break
}

if ($selection -eq 0) {
    # ALL clusters selected
    $SelectedClusters     = $clusters
    $SelectedClusterNames = $clusters.ClusterName
    $SelectedClusterIds   = $clusters.ClusterId

    Write-Host ""
    Write-Host "You selected: ALL clusters" -ForegroundColor Green
    $SelectedClusters | Format-Table -AutoSize
}
else {
    # Single cluster selected
    $selectedCluster = $clusters | Where-Object { $_.Index -eq $selection }

    $SelectedClusters     = @($selectedCluster)
    $SelectedClusterNames = @($selectedCluster.ClusterName)
    $SelectedClusterIds   = @($selectedCluster.ClusterId)

    Write-Host ""
    Write-Host "You selected cluster:" -ForegroundColor Green
    Write-Host "  Name: $($selectedCluster.ClusterName)"
    Write-Host "  Id:   $($selectedCluster.ClusterId)"
    Write-Host ""
}

# -------------------------------------------------------------
# Helper: clean kEnums -> friendly values
# -------------------------------------------------------------
function Clean-Enum {
    param(
        [string]$value
    )
    if (-not $value) { return $null }
    # remove leading 'k' if followed by capital, e.g. kLinux -> Linux, kUpgradable -> Upgradable
    $clean = $value -replace '^k(?=[A-Z])', ''
    return $clean
}

# -------------------------------------------------------------
# 4️⃣ Call Agents report for selected clusters
# -------------------------------------------------------------
$URL_EP     = "https://helios.cohesity.com/irisservices/api/v1/public/reports/agents"
$allResults = @()

foreach ($cid in $SelectedClusterIds) {

    $cluster_name = ($SelectedClusters | Where-Object { $_.ClusterId -eq $cid }).ClusterName

    $headers = @{
        "apiKey"          = $apiKey
        "accessClusterId" = "$cid"
    }

    try {
        $responseAgents = Invoke-WebRequest -Method Get -Uri $URL_EP -Headers $headers
        $agents         = $responseAgents.Content | ConvertFrom-Json
    }
    catch {
        Write-Host "Failed to get agents for cluster '$cluster_name' (Id: $cid): $_" -ForegroundColor Red
        continue
    }

    if (-not $agents) {
        Write-Host "No agents returned for cluster '$cluster_name' (Id: $cid)." -ForegroundColor Yellow
        continue
    }

    foreach ($json in $agents) {

        $osClean       = Clean-Enum -value $json.hostOsType
        $healthClean   = Clean-Enum -value $json.healthStatus
        $upgradability = Clean-Enum -value $json.upgradability

        $allResults += [PSCustomObject]@{
            ClusterName          = $cluster_name
            HostIp               = $json.hostIp
            HostOsType           = $osClean
            Version              = $json.version
            Health               = $healthClean
            Upgradability        = $upgradability
            UpgradeStatusMessage = $json.upgradeStatusMessage
        }
    }
}

if (-not $allResults) {
    Write-Host ""
    Write-Host "No agent data found for the selected clusters." -ForegroundColor Yellow
    return
}

# -------------------------------------------------------------
# 5️⃣ FULL DETAIL: Agent Details table (base for all summaries)
# -------------------------------------------------------------
Write-Host ""
Write-Host "=== Agent Details (All Selected Clusters) ===" -ForegroundColor Cyan
Write-Host ""

$allResults |
    Sort-Object ClusterName, HostOsType, HostIp |
    Format-Table ClusterName,
                 HostOsType,
                 HostIp,
                 Version,
                 Health,
                 Upgradability,
                 UpgradeStatusMessage -AutoSize

# -------------------------------------------------------------
# 6️⃣ SIMPLE Client Version Summary (All Selected Clusters)
#     One row per version + a TOTAL row
#     Columns:
#       Version, Win_Healthy, Win_Unhealthy,
#       Lin_Healthy, Lin_Unhealthy,
#       Total_Healthy, Total_Unhealthy, TotalAgents
# -------------------------------------------------------------
Write-Host ""
Write-Host "=== Client Version Summary (All Selected Clusters) ===" -ForegroundColor Cyan
Write-Host ""

$versions = $allResults.Version | Where-Object { $_ } | Sort-Object -Unique
$versionSummary = @()

foreach ($v in $versions) {
    $vAgents = $allResults | Where-Object { $_.Version -eq $v }

    $wHealthy = ($vAgents | Where-Object { $_.HostOsType -eq 'Windows' -and $_.Health -eq 'Healthy' }).Count
    $wUnhlthy = ($vAgents | Where-Object { $_.HostOsType -eq 'Windows' -and $_.Health -ne 'Healthy' }).Count

    $lHealthy = ($vAgents | Where-Object { $_.HostOsType -eq 'Linux'   -and $_.Health -eq 'Healthy' }).Count
    $lUnhlthy = ($vAgents | Where-Object { $_.HostOsType -eq 'Linux'   -and $_.Health -ne 'Healthy' }).Count

    $cHealthy = ($vAgents | Where-Object { $_.Health -eq 'Healthy' }).Count
    $cUnhlthy = ($vAgents | Where-Object { $_.Health -ne 'Healthy' }).Count

    $totalAgents = $vAgents.Count

    $versionSummary += [pscustomobject]@{
        Version         = $v
        Win_Healthy     = $wHealthy
        Win_Unhealthy   = $wUnhlthy
        Lin_Healthy     = $lHealthy
        Lin_Unhealthy   = $lUnhlthy
        Total_Healthy   = $cHealthy
        Total_Unhealthy = $cUnhlthy
        TotalAgents     = $totalAgents
    }
}

if (-not $versionSummary) {
    Write-Host "No versions found in agent data." -ForegroundColor Yellow
}
else {
    # TOTAL row across all versions
    $totRow = [pscustomobject]@{
        Version         = 'TOTAL'
        Win_Healthy     = ($versionSummary.Win_Healthy     | Measure-Object -Sum).Sum
        Win_Unhealthy   = ($versionSummary.Win_Unhealthy   | Measure-Object -Sum).Sum
        Lin_Healthy     = ($versionSummary.Lin_Healthy     | Measure-Object -Sum).Sum
        Lin_Unhealthy   = ($versionSummary.Lin_Unhealthy   | Measure-Object -Sum).Sum
        Total_Healthy   = ($versionSummary.Total_Healthy   | Measure-Object -Sum).Sum
        Total_Unhealthy = ($versionSummary.Total_Unhealthy | Measure-Object -Sum).Sum
        TotalAgents     = ($versionSummary.TotalAgents     | Measure-Object -Sum).Sum
    }

    ($versionSummary + $totRow) |
        Format-Table Version,
                     Win_Healthy, Win_Unhealthy,
                     Lin_Healthy, Lin_Unhealthy,
                     Total_Healthy, Total_Unhealthy,
                     TotalAgents -AutoSize

    Write-Host ""
    Write-Host "Total servers (all selected clusters): $($totRow.TotalAgents)"
}

# -------------------------------------------------------------
# 7️⃣ Upgradeability Summary (All Selected Clusters)
#     upgradability: kUpgradable, kCurrent, kNonUpgradableInvalidVersion
# -------------------------------------------------------------
Write-Host ""
Write-Host "=== Upgradeability Summary (All Selected Clusters) ===" -ForegroundColor Cyan
Write-Host ""

$upgradeRows = @()

$clusterGroups = $allResults | Group-Object ClusterName
foreach ($g in $clusterGroups) {
    $cluster = $g.Name
    $agents  = $g.Group

    $totalAgents = $agents.Count

    $upgradable = ($agents | Where-Object { $_.Upgradability -eq 'Upgradable' }).Count
    $current    = ($agents | Where-Object { $_.Upgradability -eq 'Current' }).Count
    $nonUpgInv  = ($agents | Where-Object { $_.Upgradability -eq 'NonUpgradableInvalidVersion' }).Count

    $upgradeRows += [pscustomobject]@{
        Cluster                      = $cluster
        TotalAgents                  = $totalAgents
        Upgradable                   = $upgradable
        Current                      = $current
        NonUpgradableInvalidVersion  = $nonUpgInv
    }
}

$sortedUpgradeRows = $upgradeRows | Sort-Object Cluster

$totUpgRow = [pscustomobject]@{
    Cluster                      = 'TOTAL'
    TotalAgents                  = ($sortedUpgradeRows.TotalAgents | Measure-Object -Sum).Sum
    Upgradable                   = ($sortedUpgradeRows.Upgradable  | Measure-Object -Sum).Sum
    Current                      = ($sortedUpgradeRows.Current     | Measure-Object -Sum).Sum
    NonUpgradableInvalidVersion  = ($sortedUpgradeRows.NonUpgradableInvalidVersion | Measure-Object -Sum).Sum
}

($sortedUpgradeRows + $totUpgRow) |
    Format-Table Cluster, TotalAgents, Upgradable, Current, NonUpgradableInvalidVersion -AutoSize

# -------------------------------------------------------------
# 8️⃣ Problem / Failed Agents list
#     Criteria: Health != Healthy OR Upgradability = NonUpgradableInvalidVersion
# -------------------------------------------------------------
Write-Host ""
Write-Host "=== Problem / Failed Agents (Health != Healthy OR NonUpgradableInvalidVersion) ===" -ForegroundColor Cyan
Write-Host ""

$problemAgents = $allResults |
    Where-Object {
        $_.Health -ne 'Healthy' -or
        $_.Upgradability -eq 'NonUpgradableInvalidVersion'
    }

if (-not $problemAgents) {
    Write-Host "No problem/failed agents found based on current criteria." -ForegroundColor Green
}
else {
    $problemAgents |
        Sort-Object ClusterName, Health, HostIp |
        Format-Table ClusterName, HostIp, HostOsType, Version, Health, Upgradability, UpgradeStatusMessage -AutoSize
}
