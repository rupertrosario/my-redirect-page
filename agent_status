$ErrorActionPreference = 'Stop'

# -------------------------------------------------------------
# 0️⃣ API key from your path
# -------------------------------------------------------------
$apikeypath = "X:\PowerShell\Cohesity_API_Scripts\DO_NOT_Delete\apikey.txt"
if (-not (Test-Path $apikeypath)) { 
    throw "API key file not found at $apikeypath" 
}

$apiKey        = (Get-Content -Path $apikeypath -Raw).Trim()
$commonHeaders = @{ "apiKey" = $apiKey }

# -------------------------------------------------------------
# 1️⃣ Get Clusters (ClusterName + ClusterId)
# -------------------------------------------------------------
$url      = "https://helios.cohesity.com/v2/mcm/cluster-mgmt/info"
$response = Invoke-WebRequest -Method Get -Uri $url -Headers $commonHeaders
$json     = $response.Content | ConvertFrom-Json
$json_clu = $json.cohesityClusters

if (-not $json_clu -or $json_clu.Count -eq 0) { 
    throw "No clusters returned from Helios." 
}

# -------------------------------------------------------------
# 2️⃣ Sort alphabetically and build index
# -------------------------------------------------------------
$sorted = $json_clu | Sort-Object -Property clusterName

$clusters = for ($i = 0; $i -lt $sorted.Count; $i++) {
    [pscustomobject]@{
        Index       = $i + 1
        ClusterName = $sorted[$i].clusterName
        ClusterId   = $sorted[$i].clusterId
    }
}

Write-Host ""
Write-Host "Available Helios Clusters (sorted by name):" -ForegroundColor Cyan
$clusters | Format-Table -AutoSize

Write-Host ""
Write-Host "[0] All clusters" -ForegroundColor Yellow
Write-Host "[X] Exit without selecting" -ForegroundColor Yellow
Write-Host ""

# -------------------------------------------------------------
# 3️⃣ Let user select ALL, ONE, or EXIT
# -------------------------------------------------------------
$selection = $null

while ($true) {

    $inputVal = Read-Host "Enter 0 for ALL, 1-$($clusters.Count) for single, or X to exit"

    # Exit option
    if ($inputVal -match '^(x|X|q|Q)$') {
        Write-Host "Exit selected. No clusters chosen." -ForegroundColor Cyan
        return
    }

    # Numeric?
    [int]$num = 0
    if (-not [int]::TryParse($inputVal, [ref]$num)) {
        Write-Host "Please enter a valid number or X to exit." -ForegroundColor Red
        continue
    }

    if ($num -lt 0 -or $num -gt $clusters.Count) {
        Write-Host "Please enter 0, 1-$($clusters.Count), or X to exit." -ForegroundColor Red
        continue
    }

    $selection = $num
    break
}

if ($selection -eq 0) {
    # ALL clusters selected
    $SelectedClusters     = $clusters
    $SelectedClusterNames = $clusters.ClusterName
    $SelectedClusterIds   = $clusters.ClusterId

    Write-Host ""
    Write-Host "You selected: ALL clusters" -ForegroundColor Green
    $SelectedClusters | Format-Table -AutoSize
}
else {
    # Single cluster selected
    $selectedCluster = $clusters | Where-Object { $_.Index -eq $selection }

    $SelectedClusters     = @($selectedCluster)
    $SelectedClusterNames = @($selectedCluster.ClusterName)
    $SelectedClusterIds   = @($selectedCluster.ClusterId)

    Write-Host ""
    Write-Host "You selected cluster:" -ForegroundColor Green
    Write-Host "  Name: $($selectedCluster.ClusterName)"
    Write-Host "  Id:   $($selectedCluster.ClusterId)"
    Write-Host ""
}

# -------------------------------------------------------------
# 4️⃣ Call Agents report for selected clusters
# -------------------------------------------------------------
$URL_EP     = "https://helios.cohesity.com/irisservices/api/v1/public/reports/agents"
$allResults = @()

foreach ($cid in $SelectedClusterIds) {

    $cluster_name = ($SelectedClusters | Where-Object { $_.ClusterId -eq $cid }).ClusterName

    $headers = @{
        "apiKey"          = $apiKey
        "accessClusterId" = "$cid"
    }

    # If you don’t need filters, you can drop $body entirely
    $body = @{
        # Example filters (commented out)
        # runStatus = "Running"
        # isDeleted = "False"
        # isPaused  = "False"
        # isActive  = "True"
    }

    try {
        $responseAgents = Invoke-WebRequest -Method Get -Uri $URL_EP -Headers $headers -Body $body
        $agents         = $responseAgents.Content | ConvertFrom-Json
    }
    catch {
        Write-Host "Failed to get agents for cluster '$cluster_name' (Id: $cid): $_" -ForegroundColor Red
        continue
    }

    if (-not $agents) {
        Write-Host "No agents returned for cluster '$cluster_name' (Id: $cid)." -ForegroundColor Yellow
        continue
    }

    foreach ($json in $agents) {

        # Clean enums: kLinux -> Linux, kWindows -> Windows, etc.
        $osClean      = $json.hostOsType        -replace '^k(?=[A-Z])',''
        $healthClean  = $json.healthStatus      -replace '^k(?=[A-Z])',''
        $lastUpgClean = $json.lastUpgradeStatus -replace '^k(?=[A-Z])',''

        $allResults += [PSCustomObject]@{
            ClusterName          = $cluster_name

            HostOsType           = $osClean
            HostOsTypeRaw        = $json.hostOsType

            HostIp               = $json.hostIp
            Version              = $json.version

            Health               = $healthClean
            HealthRaw            = $json.healthStatus

            Upgradability        = $json.upgradability
            LastUpgradeStatus    = $lastUpgClean
            LastUpgradeStatusRaw = $json.lastUpgradeStatus

            UpgradeStatusMessage = $json.upgradeStatusMessage
        }
    }
}

if (-not $allResults) {
    Write-Host ""
    Write-Host "No agent data found for the selected clusters." -ForegroundColor Yellow
    return
}

# -------------------------------------------------------------
# 5️⃣ Detailed table
# -------------------------------------------------------------
Write-Host ""
Write-Host "=== Agent Details (per host) ===" -ForegroundColor Cyan

$allResults |
    Sort-Object ClusterName, HostOsType, HostIp |
    Format-Table ClusterName,
                 HostOsType,
                 HostIp,
                 Version,
                 Health,
                 Upgradability,
                 LastUpgradeStatus,
                 UpgradeStatusMessage -AutoSize

# -------------------------------------------------------------
# 6️⃣ Summary statistics
# -------------------------------------------------------------
Write-Host ""
Write-Host "=== Summary ===" -ForegroundColor Cyan

$totalServers  = $allResults.Count
$totalOsTypes  = ($allResults.HostOsType | Select-Object -Unique).Count
$totalVersions = ($allResults.Version    | Select-Object -Unique).Count

Write-Host "Total servers (agents):       $totalServers"
Write-Host "Distinct OS types:            $totalOsTypes"
Write-Host "Distinct client versions:     $totalVersions"
Write-Host ""

# ---- OS breakdown
Write-Host "OS breakdown:" -ForegroundColor Yellow
$allResults |
    Group-Object HostOsType |
    Sort-Object Name |
    Format-Table @{Name='OS';Expression={$_.Name}},
                 @{Name='Count';Expression={$_.Count}} -AutoSize
Write-Host ""

# ---- Version breakdown
Write-Host "Client version breakdown:" -ForegroundColor Yellow
$allResults |
    Group-Object Version |
    Sort-Object Name |
    Format-Table @{Name='Version';Expression={$_.Name}},
                 @{Name='Count';Expression={$_.Count}} -AutoSize
Write-Host ""

# ---- Health breakdown + healthy / unhealthy
Write-Host "Health breakdown:" -ForegroundColor Yellow
$healthGroups = $allResults |
    Group-Object Health |
    Sort-Object Name

$healthGroups |
    Format-Table @{Name='Health';Expression={$_.Name}},
                 @{Name='Count';Expression={$_.Count}} -AutoSize

$healthyCount   = ($allResults | Where-Object { $_.Health -eq 'Healthy' }).Count
$unhealthyCount = $totalServers - $healthyCount

Write-Host ""
Write-Host "Healthy servers:   $healthyCount"
Write-Host "Unhealthy servers: $unhealthyCount"
Write-Host ""

# ---- Last upgrade status breakdown
Write-Host "Last upgrade status breakdown:" -ForegroundColor Yellow
$allResults |
    Group-Object LastUpgradeStatus |
    Sort-Object Name |
    Format-Table @{Name='LastUpgradeStatus';Expression={$_.Name}},
                 @{Name='Count';Expression={$_.Count}} -AutoSize
