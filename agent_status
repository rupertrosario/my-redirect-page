# -------------------------------------------------------------------
# Agents report per selected cluster
# Assumes: $ApiKey, $cluster_name, $cluster_id already set above
# -------------------------------------------------------------------
$URL_EP  = "https://helios.cohesity.com/irisservices/api/v1/public/reports/agents"
$results = @()

$headers = @{
    "apiKey"         = $ApiKey
    "accessClusterId"= "$cluster_id"
}

$body = @{
    <# Optional filters, uncomment if needed
    runStatus = "Running"
    isDeleted = "False"
    isPaused  = "False"
    isActive  = "True"
    hostOsType = "kWindows"
    #>
}

$response = Invoke-WebRequest -Method Get -Uri $URL_EP -Headers $headers -Body $body
$json1    = $response.Content | ConvertFrom-Json

foreach ($json in $json1) {

    # Clean enums: kLinux -> Linux, kHealthy -> Healthy, etc.
    $osClean       = $json.hostOsType       -replace '^k(?=[A-Z])',''
    $healthClean   = $json.healthStatus     -replace '^k(?=[A-Z])',''
    $lastUpgClean  = $json.lastUpgradeStatus -replace '^k(?=[A-Z])',''

    $results += [PSCustomObject]@{
        ClusterName          = $cluster_name

        HostOsTypeRaw        = $json.hostOsType
        HostOsType           = $osClean

        HostIp               = $json.hostIp
        Version              = $json.version

        HealthRaw            = $json.healthStatus
        Health               = $healthClean

        Upgradability        = $json.upgradability
        LastUpgradeStatusRaw = $json.lastUpgradeStatus
        LastUpgradeStatus    = $lastUpgClean

        UpgradeStatusMessage = $json.upgradeStatusMessage
    }
}

# ------------------ 1) Detailed table -------------------------------
Write-Host ""
Write-Host "=== Agent Details ===" -ForegroundColor Cyan

$results |
    Sort-Object ClusterName, HostOsType, HostIp |
    Format-Table ClusterName,
                 HostOsType,
                 HostIp,
                 Version,
                 Health,
                 Upgradability,
                 LastUpgradeStatus,
                 UpgradeStatusMessage -AutoSize

# ------------------ 2) Summary stats --------------------------------
Write-Host ""
Write-Host "=== Summary ===" -ForegroundColor Cyan

$totalServers   = $results.Count
$totalOsTypes   = ($results.HostOsType | Select-Object -Unique).Count
$totalVersions  = ($results.Version   | Select-Object -Unique).Count

Write-Host "Total servers (agents): $totalServers"
Write-Host "Distinct OS types:      $totalOsTypes"
Write-Host "Distinct client versions: $totalVersions"
Write-Host ""

# OS breakdown
Write-Host "OS breakdown:" -ForegroundColor Yellow
$results |
    Group-Object HostOsType |
    Sort-Object Name |
    Format-Table @{Name='OS';Expression={$_.Name}},
                 @{Name='Count';Expression={$_.Count}} -AutoSize
Write-Host ""

# Version breakdown
Write-Host "Client version breakdown:" -ForegroundColor Yellow
$results |
    Group-Object Version |
    Sort-Object Name |
    Format-Table @{Name='Version';Expression={$_.Name}},
                 @{Name='Count';Expression={$_.Count}} -AutoSize
Write-Host ""

# Health breakdown + healthy / unhealthy counts
Write-Host "Health breakdown:" -ForegroundColor Yellow
$healthGroups = $results |
    Group-Object Health |
    Sort-Object Name

$healthGroups |
    Format-Table @{Name='Health';Expression={$_.Name}},
                 @{Name='Count';Expression={$_.Count}} -AutoSize

$healthyCount   = ($results | Where-Object { $_.Health -eq 'Healthy' }).Count
$unhealthyCount = $totalServers - $healthyCount

Write-Host ""
Write-Host "Healthy servers:   $healthyCount"
Write-Host "Unhealthy servers: $unhealthyCount"
Write-Host ""

# Last upgrade status breakdown
Write-Host "Last upgrade status breakdown:" -ForegroundColor Yellow
$results |
    Group-Object LastUpgradeStatus |
    Sort-Object Name |
    Format-Table @{Name='LastUpgradeStatus';Expression={$_.Name}},
                 @{Name='Count';Expression={$_.Count}} -AutoSize
