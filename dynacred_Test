import { credentialVaultClient } from '@dynatrace-sdk/client';

export default async function () {
  const vault = credentialVaultClient();

  // ✅ Set one of these (prefer ID). Leave the other as null.
  const CREDS_ID   = "CREDENTIALS_VAULT-REPLACE_WITH_ID";  // e.g. CREDENTIALS_VAULT-1234...
  const CREDS_NAME = null;                                  // e.g. "cohesity-helios-api-key"

  // --- Resolve credential (by ID or Name) ---
  let cred;
  if (CREDS_ID) {
    cred = await vault.getCredential({ id: CREDS_ID });
  } else if (CREDS_NAME) {
    const { items } = await vault.listCredentials({ pageSize: 100 });
    const hit = items.find(i => i.name === CREDS_NAME);
    if (!hit) throw new Error(`Credential not found by name: ${CREDS_NAME}`);
    cred = await vault.getCredential({ id: hit.id });
  } else {
    throw new Error("Configure CREDS_ID or CREDS_NAME to read a credential.");
  }

  const apiKey = cred?.token ?? cred?.password;
  if (!apiKey) throw new Error("Vault credential has no token/password value.");

  const baseUrl = "https://helios.cohesity.com";
  const headers = { accept: "application/json", apiKey };   // Helios expects header: apiKey

  // --- Test call: list clusters ---
  const url = `${baseUrl}/v2/mcm/cluster-mgmt/info`;
  const resp = await fetch(url, { method: "GET", headers });

  if (!resp.ok) {
    // Don’t log secrets; just return server text
    const txt = await resp.text().catch(() => "");
    throw new Error(`Cluster list failed: HTTP ${resp.status}${txt ? " – " + txt : ""}`);
  }

  const clusters = (await resp.json())?.cohesityClusters || [];
  console.log(`✅ Helios reachable. Clusters: ${clusters.length}`);
  return { clustersCount: clusters.length };
}
