import { credentialVaultClient } from '@dynatrace-sdk/client';

export default async function () {
  const vault = credentialVaultClient();
  const { token, password } = await vault.getCredential({
    id: "CREDENTIALS_VAULT-REPLACE_WITH_ID"
  });

  const apiKey  = token || password;          // Helios expects header `apiKey: <value>`
  const baseUrl = "https://helios.cohesity.com";
  const headers = { accept: "application/json", apiKey };

  const resp = await fetch(`${baseUrl}/v2/mcm/cluster-mgmt/info`, { method: "GET", headers });
  if (!resp.ok) {
    const txt = await resp.text();
    throw new Error(`Cluster list failed: HTTP ${resp.status} – ${txt}`);
  }

  const clusters = (await resp.json())?.cohesityClusters || [];
  console.log(`✅ Helios reachable. Clusters: ${clusters.length}`);
  return { clustersCount: clusters.length };
}
