timeseries total_bytes = avg(purefa_array_space_bytes),
           util_pct    = avg(purefa_array_space_utilization),
           by: { dt.entity.purestorage:fa-array },
           from: -5m,
           interval: 1m
// latest sample in the last 5 minutes
| fieldsAdd last_total_bytes = arrayLast(total_bytes),
            last_util_pct    = arrayLast(util_pct)
// 1st step: create total_TB
| fieldsAdd total_TB = last_total_bytes / 1000000000000.0
// 2nd step: now total_TB exists, so you can use it
| fieldsAdd used_TB  = total_TB * (last_util_pct / 100.0),
            free_TB  = total_TB - used_TB
| fields entityName(dt.entity.purestorage:fa-array),
         total_TB,
         used_TB,
         free_TB,
         last_util_pct


timeseries total_bytes = avg(purefa_array_space_bytes),
           by: { dt.entity.purestorage:fa-array },
           from: -5m,
           interval: 1m
| fieldsAdd last_total_bytes = arrayLast(total_bytes)
| fieldsAdd total_TB = last_total_bytes / 1000000000000.0
| fields entityName(dt.entity.purestorage:fa-array), total_TB
