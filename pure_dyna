timeseries total_bytes = avg(purefa_array_space_bytes),
           by: { dt.entity.purestorage:fa-array },
           from: -2h,
           interval: 1m
| summarize last_total_bytes = last(total_bytes),
            by: { dt.entity.purestorage:fa-array }
| extend total_TiB  = last_total_bytes / 1099511627776.0,
         arrayName  = replace(entityName(dt.entity.purestorage:fa-array), "FlashArray ", "")
| sort arrayName asc
| fields arrayName, last_total_bytes, total_TiB


timeseries total_bytes = avg(purefa_array_space_bytes),
           by: { dt.entity.purestorage:fa-array },
           from: -2h,
           interval: 1m
| summarize last_total_bytes = last(total_bytes),
            by: { dt.entity.purestorage:fa-array }
| extend arrayName = replace(entityName(dt.entity.purestorage:fa-array), "FlashArray ", "")
| sort arrayName asc
| fields arrayName, last_total_bytes


timeseries total_bytes = avg(purefa_array_space_bytes),
           by: { dt.entity.purestorage:fa-array },
           from: -2h,
           interval: 1m
| fieldsAdd last_total_bytes = arrayLast(total_bytes)
| fieldsAdd total_TiB  = last_total_bytes / 1099511627776.0,
           total_TB10 = last_total_bytes / 1000000000000.0
| fields entityName(dt.entity.purestorage:fa-array),
         last_total_bytes,
         total_TiB,
         total_TB10

timeseries used_bytes = avg(purefa_array_space_bytes),
           util_pct   = avg(purefa_array_space_utilization),
           by: { dt.entity.purestorage:fa-array },
           from: -5m,
           interval: 1m
| fieldsAdd last_used_bytes = arrayLast(used_bytes),
            last_util_pct   = arrayLast(util_pct)
| fieldsAdd used_TB   = last_used_bytes / 1000000000000.0,
            total_TB  = iif(last_util_pct > 0,
                            used_TB / (last_util_pct / 100.0),
                            double(null)),
            free_TB   = total_TB - used_TB
| fieldsAdd arrayName = replaceString(
              entityName(dt.entity.purestorage:fa-array),
              "FlashArray ",
              ""
            )
| fields arrayName, total_TB, used_TB, free_TB, last_util_pct
