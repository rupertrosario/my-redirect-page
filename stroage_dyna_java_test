import { execution } from "@dynatrace-sdk/automation-utils";

export default async function ({ execution_id }) {
  // 1) Read workflow execution + DQL result (READ-ONLY)
  const ex     = await execution(execution_id);
  const result = await ex.result(execute_dql_query_1);  // your DQL step ID
  const rows   = result.records ?? [];

  const BYTES_PER_TB = 1_000_000_000_000;

  function safeNum(x) {
    const n = Number(x);
    return Number.isFinite(n) ? n : 0;
  }

  // HTML escaping so the table is safe (no HTML injection)
  function escapeHtml(str) {
    return String(str)
      .replace(/&/g, "&amp;")
      .replace(/</g, "&lt;")
      .replace(/>/g, "&gt;")
      .replace(/"/g, "&quot;")
      .replace(/'/g, "&#39;");
  }

  function badge(p) {
    const n = Number(p);
    if (!Number.isFinite(n)) return "âšª";
    if (n < 70) return "ðŸŸ¢";
    if (n < 85) return "ðŸŸ¡";
    return "ðŸ”´";
  }

  // 2) Normalize DQL rows â†’ clusters
  const clusters = rows
    .map((r) => {
      const clusterName = r.clusterName ?? "Unknown";

      const usedTB  = safeNum(r.used_TB);
      const totalTB = safeNum(r.total_TB);

      const usedPctRaw =
        r.used_pct_rounded != null
          ? safeNum(r.used_pct_rounded)
          : (totalTB > 0 ? (usedTB / totalTB) * 100 : 0);

      const usedPctLabel =
        typeof r.used_pct_label === "string"
          ? r.used_pct_label
          : `${usedPctRaw.toFixed(1)} %`;

      const usedHddTB  = safeNum(r.used_hdd_bytes)  / BYTES_PER_TB;
      const totalHddTB = safeNum(r.total_hdd_bytes) / BYTES_PER_TB;
      const usedSddTB  = safeNum(r.used_sdd_bytes)  / BYTES_PER_TB;
      const totalSddTB = safeNum(r.total_sdd_bytes) / BYTES_PER_TB;

      const usedHddPct =
        totalHddTB > 0 ? (usedHddTB / totalHddTB) * 100 : 0;
      const usedSddPct =
        totalSddTB > 0 ? (usedSddTB / totalSddTB) * 100 : 0;

      return {
        clusterName,
        usedPct:      usedPctRaw.toFixed(1),
        usedPctLabel,
        status:       badge(usedPctRaw),

        usedHddTB:    usedHddTB.toFixed(1),
        totalHddTB:   totalHddTB.toFixed(1),
        usedHddPct:   usedHddPct.toFixed(1),

        usedSddTB:    usedSddTB.toFixed(1),
        totalSddTB:   totalSddTB.toFixed(1),
        usedSddPct:   usedSddPct.toFixed(1),

        usedTB:       usedTB.toFixed(1),
        totalTB:      totalTB.toFixed(1)
      };
    })
    .sort((a, b) => a.clusterName.localeCompare(b.clusterName));

  // 3) Build HTML table (safe, no scripts, just <table>)
  const rowsHtml = clusters
    .map((c) => {
      return `
        <tr>
          <td>${escapeHtml(c.clusterName)}</td>
          <td style="text-align:right;">${escapeHtml(c.usedPct)}&nbsp;%</td>
          <td style="text-align:center;">${c.status}</td>
          <td style="text-align:right;">${escapeHtml(c.usedHddTB)}</td>
          <td style="text-align:right;">${escapeHtml(c.totalHddTB)}</td>
          <td style="text-align:right;">${escapeHtml(c.usedHddPct)}&nbsp;%</td>
          <td style="text-align:right;">${escapeHtml(c.usedSddTB)}</td>
          <td style="text-align:right;">${escapeHtml(c.totalSddTB)}</td>
          <td style="text-align:right;">${escapeHtml(c.usedSddPct)}&nbsp;%</td>
          <td style="text-align:right;">${escapeHtml(c.usedTB)}</td>
          <td style="text-align:right;">${escapeHtml(c.totalTB)}</td>
        </tr>`;
    })
    .join("");

  const htmlReport = `
<!DOCTYPE html>
<html>
  <body style="font-family: Arial, sans-serif; font-size: 13px;">
    <h2>Isilon Cluster Capacity Report</h2>
    <p style="margin-bottom: 8px;">
      Time window: last 30 minutes (Dynatrace DQL). Read-only: metrics only, no changes to Isilon.
    </p>

    <table border="1" cellpadding="4" cellspacing="0" style="border-collapse: collapse; min-width: 600px;">
      <thead style="background-color: #f0f0f0;">
        <tr>
          <th align="left">Cluster</th>
          <th align="right">Used %</th>
          <th align="center">Status</th>
          <th align="right">HDD Used TB</th>
          <th align="right">HDD Total TB</th>
          <th align="right">HDD %</th>
          <th align="right">SSD Used TB</th>
          <th align="right">SSD Total TB</th>
          <th align="right">SSD %</th>
          <th align="right">Used TB</th>
          <th align="right">Total TB</th>
        </tr>
      </thead>
      <tbody>
        ${rowsHtml || `<tr><td colspan="11" align="center">No Isilon clusters found in DQL result.</td></tr>`}
      </tbody>
    </table>

    <p style="margin-top: 10px; margin-bottom: 4px;">
      Legend (overall capacity, Used % column):
    </p>
    <ul style="margin-top: 0;">
      <li>ðŸŸ¢ Healthy: &lt; 70% used</li>
      <li>ðŸŸ¡ Warning: 70â€“84.9% used</li>
      <li>ðŸ”´ Critical: â‰¥ 85% used</li>
    </ul>

    <p style="color: #777; font-size: 11px; margin-top: 8px;">
      Report generated by Dynatrace Workflow (read-only Isilon extension metrics).
    </p>
  </body>
</html>`.trim();

  // 4) Return both the raw data and the HTML body
  return {
    clusters,
    htmlReport
  };
}
