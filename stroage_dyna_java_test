// Isilon â€“ Cluster Capacity Report with HDD + SSD Breakdown
// Input (example):
//   {
//     rows: [
//       {
//         clusterName: "Isilon-Prod-01",
//         used_bytes: 3.5e14,
//         total_bytes: 5.0e14,
//         used_hdd_bytes: 2.8e14,
//         total_hdd_bytes: 4.0e14,
//         used_sdd_bytes: 7.0e13,
//         total_sdd_bytes: 1.0e14
//       },
//       ...
//     ]
//   }
//
// Output:
//   { clusters: [...normalized], report: "ðŸ“Š **Isilon Cluster Capacity Report**\n\n| ... |" }
//
// No calls to Isilon; no email sending here â€“ just formatting.

export default async function (input) {
  const rows = input.rows || [];

  const BYTES_PER_TB = 1_000_000_000_000; // decimal TB

  function safeNum(x) {
    const n = Number(x);
    return Number.isFinite(n) ? n : 0;
  }

  function badge(p) {
    if (p == null || isNaN(p)) return "âšª N/A";
    if (p < 70) return "ðŸŸ¢ Healthy";
    if (p < 85) return "ðŸŸ¡ Warning";
    return "ðŸ”´ Critical";
  }

  const clusters = rows.map((row) => {
    const clusterName = row.clusterName ?? row.name ?? "Unknown";

    const usedBytes      = safeNum(row.used_bytes);
    const totalBytes     = safeNum(row.total_bytes);
    const usedHddBytes   = safeNum(row.used_hdd_bytes);
    const totalHddBytes  = safeNum(row.total_hdd_bytes);
    const usedSddBytes   = safeNum(row.used_sdd_bytes);
    const totalSddBytes  = safeNum(row.total_sdd_bytes);

    const usedTB     = usedBytes     / BYTES_PER_TB;
    const totalTB    = totalBytes    / BYTES_PER_TB;
    const usedHddTB  = totalHddBytes > 0 ? usedHddBytes  / BYTES_PER_TB : 0;
    const totalHddTB = totalHddBytes > 0 ? totalHddBytes / BYTES_PER_TB : 0;
    const usedSddTB  = totalSddBytes > 0 ? usedSddBytes  / BYTES_PER_TB : 0;
    const totalSddTB = totalSddBytes > 0 ? totalSddBytes / BYTES_PER_TB : 0;

    const usedPct     = totalTB    > 0 ? (usedTB    / totalTB)    * 100 : 0;
    const usedHddPct  = totalHddTB > 0 ? (usedHddTB / totalHddTB) * 100 : 0;
    const usedSddPct  = totalSddTB > 0 ? (usedSddTB / totalSddTB) * 100 : 0;

    return {
      clusterName,
      usedTB:     usedTB.toFixed(1),
      totalTB:    totalTB.toFixed(1),
      usedPct:    usedPct.toFixed(1),

      usedHddTB:  usedHddTB.toFixed(1),
      totalHddTB: totalHddTB.toFixed(1),
      usedHddPct: usedHddPct.toFixed(1),

      usedSddTB:  usedSddTB.toFixed(1),
      totalSddTB: totalSddTB.toFixed(1),
      usedSddPct: usedSddPct.toFixed(1),

      status: badge(usedPct)
    };
  }).sort((a, b) => a.clusterName.localeCompare(b.clusterName));

  const header = [
    "ðŸ“Š **Isilon Cluster Capacity Report**",
    "",
    "_Source: Dynatrace Isilon extension (last 30 minutes window)_",
    "",
    "| Cluster | Used (TB) | Total (TB) | Used % | HDD Used (TB) | HDD Total (TB) | HDD % | SSD Used (TB) | SSD Total (TB) | SSD % | Status |",
    "|---------|-----------:|-----------:|-------:|--------------:|---------------:|------:|--------------:|---------------:|------:|:--------|"
  ].join("\n");

  const body = clusters.map(c =>
    `| ${c.clusterName}` +
    ` | ${c.usedTB}` +
    ` | ${c.totalTB}` +
    ` | ${c.usedPct} %` +
    ` | ${c.usedHddTB}` +
    ` | ${c.totalHddTB}` +
    ` | ${c.usedHddPct} %` +
    ` | ${c.usedSddTB}` +
    ` | ${c.totalSddTB}` +
    ` | ${c.usedSddPct} %` +
    ` | ${c.status} |`
  ).join("\n");

  const footer = [
    "",
    `**Total clusters in report: ${clusters.length}**`,
    "",
    "Legend (overall Used % â€“ HDD+SSD):",
    "- ðŸŸ¢ Healthy: **< 70%** used",
    "- ðŸŸ¡ Warning: **70â€“84.9%** used",
    "- ðŸ”´ Critical: **â‰¥ 85%** used"
  ].join("\n");

  const report = [header, body, "", footer].join("\n");

  return {
    clusters,
    report
  };
}
