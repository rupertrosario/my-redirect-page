# ===========================
# 0) API Key from your path
# ===========================

$apikeypath = "X:\PowerShell\Cohesity_API_scripts\DO_NOT_Delete\apikey.txt"
if (-not (Test-Path $apikeypath)) { throw "API key file not found at $apikeypath" }

$ApiKey = (Get-Content -Path $apikeypath -Raw).Trim()
$commonHeaders = @{ "apiKey" = $ApiKey }

# ===========================
# 1) Get Clusters (ClusterName + ClusterId)
# ===========================

$uri = "https://helios.cohesity.com/v2/mcm/cluster-mgmt/info"
$response = Invoke-WebRequest -Method Get -Uri $uri -Headers $commonHeaders
$json_clu = $response.Content | ConvertFrom-Json
$json_clu = $json_clu.cohesityClusters

# ===========================
# 2) Get Alerts per cluster (URL already filters), extract node_ip
# ===========================

$results = @()

foreach ($clus in $json_clu) {

  $cluster_name = $clus.clusterName
  $cluster_id   = $clus.clusterId

  $headers = @{
    "apiKey"          = "$ApiKey"
    "accessClusterId" = "$cluster_id"
  }

  # URL already filters the alert type(s) you want
  $URL_EP = "https://helios.cohesity.com/v2/alerts?maxAlerts=200&alertTypes=1105&alertStates=kOpen,kNote&alertCategories=kNetworking"

  $response = Invoke-WebRequest -Method Get -Uri $URL_EP -Headers $headers
  $json = $response.Content | ConvertFrom-Json

  foreach ($alt in @($json.alerts)) {

    $prop = $alt.propertyList | Where-Object { $_.key -eq 'node_ip' } | Select-Object -First 1
    $ip   = $prop.value
    if (-not $ip) { $ip = $prop.values }   # some payloads use "values" instead of "value"

    $results += [pscustomobject]@{
      AlertCode   = $alt.alertCode
      IP          = $ip
      ClusterName = $cluster_name
      ClusterId   = $cluster_id
      Severity    = $alt.severity
      AlertState  = $alt.alertState
      Id          = $alt.id
    }
  }
}

$results
