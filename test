# ------------------------------------------------------------
# Helios Alerts: ONLY alertCode = CE3601105 -> extract node_ip from propertyList
# Reads API key from file, calls Helios alerts API (GET), returns PSCustomObject rows.
# ------------------------------------------------------------

[CmdletBinding()]
param(
    [string]$ApiKeyPath = "X:\PowerShell\Cohesity_API_scripts\DO_NOT_Delete\apikey.txt",

    # Filter(s)
    [string]$AlertCodeMatch    = "CE3601105",
    [string]$NodeIpKeyName     = "node_ip",

    # Helios endpoint + filters
    [string]$HeliosUrl         = "https://helios.cohesity.com/v2/mcm/alerts",
    [string]$AlertType         = "1105",          # you had this in the URL as alertType=1105
    [int]   $MaxAlerts         = 200,             # bump this since you may have ~200 open
    [string]$AlertCategory     = "kNetworking",
    [string]$AlertSeverity     = "kWarning"
    # If you want only open alerts, you can add alertStates in the URL (see comment below)
)

$ErrorActionPreference = "Stop"

# TLS (often needed for Helios in older PS)
try { [Net.ServicePointManager]::SecurityProtocol = [Net.SecurityProtocolType]::Tls12 } catch {}

# ---- Load API key ----
if (-not (Test-Path $ApiKeyPath)) { throw "API key file not found: $ApiKeyPath" }
$ApiKey = (Get-Content -Path $ApiKeyPath -Raw).Trim()
if ([string]::IsNullOrWhiteSpace($ApiKey)) { throw "API key file is empty: $ApiKeyPath" }

$headers = @{ apiKey = $ApiKey }

# ---- Build request ----
# NOTE: Many servers ignore GET bodies; Cohesity Helios sometimes accepts these as query params.
# You're using GET with -Body in your snippet, so keeping that behavior here.
$body = @{
    alertCategoryList  = $AlertCategory
    maxAlerts          = "$MaxAlerts"
    alertSeverityList  = $AlertSeverity
}

# URL from your screenshot
$uri = "$HeliosUrl?alertType=$AlertType"
# If you want only OPEN alerts, use something like this instead (uncomment):
# $uri = "$HeliosUrl?maxAlerts=$MaxAlerts&alertTypes=$AlertType&alertStates=kOpen&alertCategories=$AlertCategory&alertSeverities=$AlertSeverity"

# ---- Call API ----
$response = Invoke-WebRequest -Method Get -Uri $uri -Headers $headers -Body $body -UseBasicParsing
$json = $response.Content | ConvertFrom-Json

# ---- Extract matches ----
$results = @()

foreach ($alt in $json.alertsList) {

    if ($alt.alertCode -ne $AlertCodeMatch) { continue }

    # propertyList -> find node_ip
    $prop = $alt.propertyList | Where-Object { $_.key -eq $NodeIpKeyName } | Select-Object -First 1

    $ip = $prop.value
    if (-not $ip) { $ip = $prop.values }  # some payloads use "values" instead of "value"
    if (-not $ip) { continue }

    $results += [pscustomobject]@{
        AlertCode   = $alt.alertCode
        IP          = $ip
        ClusterName = $alt.clusterName
        ClusterId   = $alt.clusterId
        Severity    = $alt.severity
        AlertState  = $alt.alertState
        Id          = $alt.id
        # Keep the full details if you need it (uncomment):
        # AlertDocument = $alt.alertDocument
        # PropertyList  = $alt.propertyList
    }
}

$results
