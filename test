# ===========================
# 0) API Key from your path
# ===========================

$apikeypath = "X:\PowerShell\Cohesity_API_scripts\DO_NOT_Delete\apikey.txt"
if (-not (Test-Path $apikeypath)) { throw "API key file not found at $apikeypath" }

$ApiKey  = (Get-Content -Path $apikeypath -Raw).Trim()
$results = @()

$headers = @{
  "apiKey" = "$ApiKey"
}

# GET filters in URL (simple + reliable)
$URL_EP = "https://helios.cohesity.com/v2/mcm/alerts" +
          "?alertType=1105" +
          "&alertCategoryList=kNetworking" +
          "&alertSeverityList=kWarning" +
          "&maxAlerts=200"

$response = Invoke-WebRequest -Method Get -Uri $URL_EP -Headers $headers -UseBasicParsing
$json = $response.Content | ConvertFrom-Json

# IMPORTANT: alertsList is coming as System.Object (single object / wrapper)
# So we MUST force to an array OR unwrap if it contains the real list inside it.
$alerts = @()

if ($null -ne $json.alertsList) {
  # If alertsList itself is enumerable (array), this becomes the list.
  $alerts = @($json.alertsList)
}

# If itâ€™s a wrapper (common), try typical inner property names without getting fancy
if ($alerts.Count -eq 1 -and $alerts[0] -and ($alerts[0].PSObject.Properties.Name -contains 'alerts')) {
  $alerts = @($alerts[0].alerts)
}
elseif ($alerts.Count -eq 1 -and $alerts[0] -and ($alerts[0].PSObject.Properties.Name -contains 'items')) {
  $alerts = @($alerts[0].items)
}
elseif ($alerts.Count -eq 1 -and $alerts[0] -and ($alerts[0].PSObject.Properties.Name -contains 'alertList')) {
  $alerts = @($alerts[0].alertList)
}

foreach ($alt in $alerts) {

  if ($alt.alertCode -eq 'CE3601105') {

    $prop = $alt.propertyList | Where-Object { $_.key -eq 'node_ip' } | Select-Object -First 1

    $ip = $prop.value
    if (-not $ip) { $ip = $prop.values }
    if (-not $ip) { continue }

    $results += [pscustomobject]@{
      AlertCode   = $alt.alertCode
      IP          = $ip
      ClusterName = $alt.clusterName
      ClusterId   = $alt.clusterId
      Severity    = $alt.severity
      AlertState  = $alt.alertState
      Id          = $alt.id
    }
  }
}

$results
