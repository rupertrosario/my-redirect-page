# ===========================
# 0) API Key from your path
# ===========================

$apikeypath = "X:\PowerShell\Cohesity_API_scripts\DO_NOT_Delete\apikey.txt"
if (-not (Test-Path $apikeypath)) { throw "API key file not found at $apikeypath" }

$ApiKey = (Get-Content -Path $apikeypath -Raw).Trim()
$results = @()

$headers = @{
  "apiKey" = "$ApiKey"
}

$body = @{
  alertCategoryList = "kNetworking"
  maxAlerts         = "200"
  alertSeverityList = "kWarning"
}

$URL_EP = "https://helios.cohesity.com/v2/mcm/alerts?alertType=1105"

$response = Invoke-WebRequest -Method Get -Uri $URL_EP -Headers $headers -Body $body
$json = $response.Content | ConvertFrom-Json
#$json

foreach ($alt in $json.alertsList) {

  if ($alt.alertCode -eq 'CE3601105') {

    $prop = $alt.propertyList | Where-Object { $_.key -eq 'node_ip' } | Select-Object -First 1

    $ip = $prop.value
    if (-not $ip) { $ip = $prop.values }   # some payloads use "values" instead of "value"
    if (-not $ip) { continue }

    $results += [pscustomobject]@{
      AlertCode   = $alt.alertCode
      IP          = $ip
      ClusterName = $alt.clusterName
      ClusterId   = $alt.clusterId
      Severity    = $alt.severity
      AlertState  = $alt.alertState
      Id          = $alt.id
    }
  }
}

$results
