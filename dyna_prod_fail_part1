import { credentialVaultClient } from "@dynatrace-sdk/client-classic-environment-v2";

/**
 * cohesity_backup_failures_p1
 * READ-ONLY (GET-only)
 * - All clusters
 * - All active PGs (no retention/policy filter)
 *
 * Output -> Part 2 reads via result("cohesity_backup_failures_p1")
 */
export default async function () {
  const baseUrl = "https://helios.cohesity.com";
  const numRuns = 5;

  // ==============================
  // AUTH (vault id)  âœ… (same style)
  // ==============================
  const vaultId = "credentials_vault-312312";
  const d2 = await credentialVaultClient.getCredentialsDetails({ id: vaultId });
  const apiKey = (d2?.token || d2?.password || "").trim();
  if (!apiKey) throw new Error("No Helios API key available (empty token/password).");

  const commonHeaders = { accept: "application/json", apiKey };

  async function getJson(url, headers) {
    const resp = await fetch(url, { method: "GET", headers });
    if (!resp.ok) {
      let txt = "";
      try { txt = await resp.text(); } catch (_) {}
      throw new Error(`GET ${url} -> HTTP ${resp.status} ${txt}`);
    }
    return resp.json();
  }

  // clusters
  const clu = await getJson(`${baseUrl}/v2/mcm/cluster-mgmt/info`, { ...commonHeaders, Accept: "application/json" });
  const clusters = Array.isArray(clu?.cohesityClusters) ? clu.cohesityClusters : [];
  if (!clusters.length) throw new Error("No clusters returned from /v2/mcm/cluster-mgmt/info");

  // active PG index (minimal)
  const pgIndex = [];

  for (const cl of clusters) {
    const clusterId = cl?.clusterId;
    const clusterName =
      String(cl?.name || cl?.clusterName || cl?.displayName || "").trim() || `Unknown-${clusterId}`;
    if (!clusterId) continue;

    const headers = { ...commonHeaders, Accept: "application/json", accessClusterId: String(clusterId) };

    let pgJson;
    try {
      pgJson = await getJson(
        `${baseUrl}/v2/data-protect/protection-groups?isDeleted=false&isPaused=false&isActive=true`,
        headers
      );
    } catch (_) {
      continue; // fail-open per cluster
    }

    const pgs = Array.isArray(pgJson?.protectionGroups) ? pgJson.protectionGroups : [];
    if (!pgs.length) continue;

    for (const pg of pgs) {
      const pgId = pg?.id;
      const pgName = pg?.name || "";
      if (!pgId) continue;

      const pgEnv =
        (pg.environment && String(pg.environment)) ||
        (pg.environments && String(pg.environments)) ||
        (Array.isArray(pg.environmentTypes) ? pg.environmentTypes.join(",") : "") ||
        "UnknownEnv";

      pgIndex.push({
        clusterId: String(clusterId),
        clusterName,
        pgId: String(pgId),
        pgName,
        pgEnv,
      });
    }
  }

  return {
    authMode: "vault",
    baseUrl,
    numRuns,
    pgIndex,
  };
}
