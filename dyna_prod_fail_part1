import { credentialVaultClient } from "@dynatrace-sdk/client-classic-environment-v2";

/**
 * Part 1: Vault + cluster inventory + tunables
 * - GET-only
 * - Output is consumed by Part 2 via result("cohesity_backup_failures_p1")
 */
export default async function () {
  const baseUrl = "https://helios.cohesity.com";
  const numRuns = 20; // <-- same as PS baseline (can change)

  // Vault auth
  const vaultId = "credentials_vault-312312";
  const d = await credentialVaultClient.getCredentialsDetails({ id: vaultId });
  const apiKey = (d?.token || d?.password || "").trim();
  if (!apiKey) throw new Error("No Helios API key available (empty token/password).");

  const commonHeaders = { accept: "application/json", apiKey };

  async function getJson(url, headers) {
    const resp = await fetch(url, { method: "GET", headers });
    if (!resp.ok) {
      let txt = "";
      try { txt = await resp.text(); } catch (_) {}
      throw new Error(`GET ${url} -> HTTP ${resp.status} ${txt}`);
    }
    return resp.json();
  }

  const clu = await getJson(`${baseUrl}/v2/mcm/cluster-mgmt/info`, { ...commonHeaders, Accept: "application/json" });
  const clusters = Array.isArray(clu?.cohesityClusters) ? clu.cohesityClusters : [];
  if (!clusters.length) throw new Error("No clusters returned from /v2/mcm/cluster-mgmt/info");

  const clusterIndex = clusters
    .map((c) => ({
      clusterId: c?.clusterId ? String(c.clusterId) : "",
      clusterName: String(c?.name || c?.clusterName || c?.displayName || "").trim(),
    }))
    .filter((c) => c.clusterId && c.clusterName);

  return {
    authMode: "vault",
    baseUrl,
    numRuns,
    clusterIndex,
    clusterCount: clusterIndex.length,
  };
}
