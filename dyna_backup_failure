// ServiceNow – Upsert Incident from Cohesity payload — SPLIT #2 (SNOW only)
// Input expected: cohesityPayload = output object from Script #1

import { credentialVaultClient } from "@dynatrace-sdk/client-classic-environment-v2";

export default async function ({ cohesityPayload }) {
  // ======================
  // REQUIRED: SNOW config
  // ======================
  const snowBaseUrl = "https://YOUR_INSTANCE.service-now.com";
  const snowTable = "incident";

  // Credential vault for SNOW (set these in Dynatrace credential vault)
  const snowVaultName = "ServiceNow_API";
  const snowVaultId = "credentials_vault-XXXXXX";

  // If your SNOW uses Basic auth: store username in token field and password in password field (or vice versa),
  // then map below accordingly.
  let snowUser = null;
  let snowPass = null;
  let snowAuthMode = "vault-name";

  async function getSnowCredsByName(name) {
    const all = await credentialVaultClient.getCredentials();
    const found = all.credentials.find((c) => c.name === name);
    if (!found) return null;
    const detail = await credentialVaultClient.getCredentialsDetails({ id: found.id });
    return detail || null;
  }

  try {
    const d = await getSnowCredsByName(snowVaultName);
    if (!d) throw new Error("not-found");
    snowAuthMode = "vault-name";
    // Adjust these two lines to your vault layout:
    snowUser = d.token || null;
    snowPass = d.password || null;
  } catch (e) {
    try {
      const d = await credentialVaultClient.getCredentialsDetails({ id: snowVaultId });
      snowAuthMode = "vault-id";
      snowUser = d.token || null;
      snowPass = d.password || null;
    } catch (e2) {
      snowAuthMode = "manual";
      snowUser = "SNOW_USERNAME";
      snowPass = "SNOW_PASSWORD";
    }
  }

  if (!snowUser || !snowPass) {
    throw new Error("No ServiceNow credentials available (vault + manual failed).");
  }

  // ======================
  // Payload
  // ======================
  const p = cohesityPayload || {};
  const failures = Array.isArray(p.failures) ? p.failures : [];
  const snow_query = p.snow_query || "";
  const snow_short_description = p.snow_short_description || "Cohesity — Backup failures (latest uncleared)";
  const snow_description_create = p.snow_description_create || "";
  const snow_description_update = p.snow_description_update || "";

  // If no failures, do NOT create/update SNOW (keep fast + avoid noise)
  if (failures.length === 0) {
    return {
      snowAuthMode: snowAuthMode,
      action: "noop",
      reason: "No failures in payload",
      query: snow_query,
      incident_sys_id: null,
      incident_number: null
    };
  }

  // ======================
  // SNOW helpers
  // ======================
  function basicAuthHeader(user, pass) {
    const token = Buffer.from(`${user}:${pass}`).toString("base64");
    return `Basic ${token}`;
  }

  async function snowFetch(path, method, bodyObj) {
    const url = `${snowBaseUrl}${path}`;
    const headers = {
      "Accept": "application/json",
      "Content-Type": "application/json",
      "Authorization": basicAuthHeader(snowUser, snowPass)
    };

    const resp = await fetch(url, {
      method,
      headers,
      body: bodyObj ? JSON.stringify(bodyObj) : undefined
    });

    const txt = await resp.text();
    let json = null;
    try { json = txt ? JSON.parse(txt) : null; } catch {}

    if (!resp.ok) {
      throw new Error(`${method} ${url} -> HTTP ${resp.status} ${txt}`);
    }
    return json;
  }

  // ======================
  // 1) Search existing incident
  // ======================
  const search = await snowFetch(
    `/api/now/table/${snowTable}?sysparm_limit=1&sysparm_query=${encodeURIComponent(snow_query)}`,
    "GET"
  );

  const found = search && search.result && search.result.length ? search.result[0] : null;

  // ======================
  // 2) Update OR Create
  // ======================
  if (found && found.sys_id) {
    const sysId = found.sys_id;

    const upd = await snowFetch(
      `/api/now/table/${snowTable}/${encodeURIComponent(sysId)}`,
      "PATCH",
      {
        short_description: snow_short_description,
        description: snow_description_update
      }
    );

    const number = (upd && upd.result && upd.result.number) ? upd.result.number : (found.number || null);

    return {
      snowAuthMode: snowAuthMode,
      action: "update",
      query: snow_query,
      incident_sys_id: sysId,
      incident_number: number
    };
  }

  const crt = await snowFetch(
    `/api/now/table/${snowTable}`,
    "POST",
    {
      short_description: snow_short_description,
      description: snow_description_create
    }
  );

  const sysId = (crt && crt.result && crt.result.sys_id) ? crt.result.sys_id : null;
  const number = (crt && crt.result && crt.result.number) ? crt.result.number : null;

  return {
    snowAuthMode: snowAuthMode,
    action: "create",
    query: snow_query,
    incident_sys_id: sysId,
    incident_number: number
  };
}
