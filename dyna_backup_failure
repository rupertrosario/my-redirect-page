// ==============================
// SCRIPT 2/2
// ServiceNow payload builder (NO Helios calls)
// INPUT: map Script-1 output into this script as "cohesity"
// RETURNS: adds SNOW strings while preserving Script-1 fields.
// ==============================

export default async function (input) {
  const cohesity =
    (input && (input.cohesity || input.payload || input.result || input)) || {};

  const failures = Array.isArray(cohesity.failures) ? cohesity.failures : [];
  const count = Number.isFinite(cohesity.count) ? cohesity.count : failures.length;

  // ---- tune these two strings to match your SNOW search step exactly ----
  const snow_short_description = `Cohesity backup failures (uncleared) - ${count}`;

  // Example sysparm_query (adjust fields: assignment_group, cmdb_ci, etc.)
  // Keep it stable so “search -> update/create” behaves deterministically.
  const snow_query = `active=true^short_descriptionSTARTSWITHCohesity backup failures`;

  // Descriptions:
  // - create: NO FailedMessage (use incidentText_create)
  // - update: WITH FailedMessage (use incidentText_update)
  const snow_description_create =
    cohesity.incidentText_create ||
    (count ? `Cohesity backup failures detected. Count: ${count}` : "No failures.");

  const snow_description_update =
    cohesity.incidentText_update ||
    (count ? `Cohesity backup failures detected. Count: ${count}` : "No failures.");

  // If you want the markdown table inside SNOW description, append here:
  // (uncomment if your SNOW field supports it)
  // const md = cohesity.markdownTable || "";
  // const snow_description_update = `${cohesity.incidentText_update}\n\n${md}`;

  return {
    // pass-through from Script 1
    authMode: cohesity.authMode,
    count: count,
    failures: failures,
    incidentText_create: cohesity.incidentText_create,
    incidentText_update: cohesity.incidentText_update,
    markdownTable: cohesity.markdownTable,
    markdownEmail: cohesity.markdownEmail,

    // SNOW fields for downstream steps
    snow_query: snow_query,
    snow_short_description: snow_short_description,
    snow_description_create: snow_description_create,
    snow_description_update: snow_description_update
  };
}
