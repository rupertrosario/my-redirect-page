// ===============================
// Script #2 — Pass-through / Normalizer (NO SNOW)
// ===============================
// Reads Script #1 output via automation-utils result()
// Keeps your exact return shape (as in your picture)

import { result } from "@dynatrace-sdk/automation-utils";

export default async function () {
  // IMPORTANT: this string must match the workflow action id/name of Script #1
  const p = await result("run_javascript_1");

  const authMode = p?.authMode ?? "unknown";
  const failures = Array.isArray(p?.failures) ? p.failures : [];
  const count = typeof p?.count === "number" ? p.count : failures.length;

  const incidentText_create =
    typeof p?.incidentText_create === "string"
      ? p.incidentText_create
      : (count === 0 ? "✅ No failures." : `Count: ${count}`);

  const incidentText_update =
    typeof p?.incidentText_update === "string"
      ? p.incidentText_update
      : incidentText_create;

  const markdownTable =
    typeof p?.markdownTable === "string"
      ? p.markdownTable
      : (count === 0 ? "✅ No failures." : "");

  // Keep snow fields present (blank) to match your required output signature
  const snow_query = typeof p?.snow_query === "string" ? p.snow_query : "";
  const snow_short_description = typeof p?.snow_short_description === "string" ? p.snow_short_description : "";
  const snow_description_create = typeof p?.snow_description_create === "string" ? p.snow_description_create : "";
  const snow_description_update = typeof p?.snow_description_update === "string" ? p.snow_description_update : "";

  return {
    authMode,
    count,
    failures,
    incidentText_create,
    incidentText_update,
    markdownTable,
    markdownEmail: markdownTable,
    snow_query,
    snow_short_description,
    snow_description_create,
    snow_description_update
  };
}
